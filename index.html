<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Assignment Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-section.hidden {
            display: none;
        }

        .form-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        .form-subtitle {
            text-align: center;
            color: #34495e;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group.full-width {
            flex: 1 1 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group label.required::after {
            content: " *";
            color: #e74c3c;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-group input[type="file"] {
            padding: 8px;
            border: 2px dashed #ddd;
            background-color: #f9f9f9;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .radio-item label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }

        .selected-subjects {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #4CAF50;
        }

        .selected-subjects strong {
            color: #2e7d32;
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }

        .certificate {
            background: white;
            padding: 40px;
            margin: 0;
            border: 1px solid #000000;
            font-family: Arial, sans-serif;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
        }

        .certificate-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .university-name {
            font-size: 20px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .regional-center {
            font-family: Calibri, sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #FF0000;
            margin-bottom: 0;
            text-decoration: none;
        }

        .certificate-title {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
            margin-left: 0;
        }

        .logo-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
            padding: 0;
            gap: 0;
            width: 100%;
            margin-left: -20px;
        }

        .logo-section img {
            width: 130px;
            height: 130px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .header-text {
            text-align: center;
            flex: 1;
            margin: 0 5px;
            width: 100%;
        }

        .certificate-content {
            margin: 15px 0;
        }
        
        /* A4 specific adjustments */
        @page {
            size: A4;
            margin: 15mm;
        }

        .info-row {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
        }

        .info-label {
            font-weight: bold;
            color: #333;
            min-width: 200px;
            font-size: 16px;
        }

        .info-value {
            color: #666;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding: 5px 10px;
            min-width: 300px;
        }

        .signature-section {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .signature-box {
            text-align: center;
            flex: 1;
        }

        .signature-line {
            width: 200px;
            height: 2px;
            background-color: #333;
            margin: 10px auto;
        }

        .date-section {
            text-align: center;
            margin-top: 40px;
        }

        .photo-placeholder {
            width: 120px;
            height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            margin: 20px auto;
            page-break-before: always;
        }

        .exam-info {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
            margin-left: 0;
        }

        .instructions {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
            margin-left: 0;
        }

        .assignment-details {
            margin: 10px 0;
            margin-left: 0;
        }

        .detail-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 15px;
        }

        .detail-number {
            font-weight: bold;
            color: #000000;
            min-width: 25px;
            margin-right: 8px;
        }

        .detail-label {
            font-weight: bold;
            color: #000000;
            min-width: 280px;
            margin-right: 8px;
        }

        .detail-separator {
            color: #000000;
            margin-right: 8px;
        }

        .detail-value {
            color: #000000;
            padding: 2px 8px;
            min-width: 180px;
        }

        .course-note {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin: 5px 0 15px 33px;
        }

        .submission-section {
            margin-top: 60px;
            padding-top: 20px;
        }

        .date-signature-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0;
        }

        .date-label {
            font-weight: bold;
            color: #000000;
        }

        .date-value {
            color: #000000;
            padding: 2px 8px;
            min-width: 100px;
        }

        .signature-label {
            color: #000000;
            font-weight: bold;
        }

        /* Hidden canvas for signature processing */
        #signatureCanvas {
            display: none;
        }



        .download-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .download-section h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        /* Download Page Styles */
        .download-options {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 30px;
        }

        .download-option {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .download-option:hover {
            border-color: #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .download-option h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .download-option p {
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .subject-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .subject-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .subject-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .download-all-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            font-size: 18px;
            padding: 20px 30px;
            min-width: 300px;
        }

        .download-all-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
        }

        @media print {
            .form-section, .button-group, .download-section {
                display: none;
            }
            .certificate {
                box-shadow: none;
                border: 1px solid #000000;
                margin: 0;
                padding: 40px;
                width: 210mm;
                height: 297mm;
                page-break-after: always;
            }
            
            body {
                margin: 0;
                padding: 0;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .certificate {
                padding: 30px;
                margin: 40px;
            }
            .logo-section img {
                width: 110px;
                height: 110px;
            }
            .university-name {
                font-size: 16px;
            }
            .regional-center {
                font-size: 14px;
            }
            .detail-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .detail-label {
                min-width: auto;
                margin-bottom: 5px;
            }
            .detail-value {
                min-width: auto;
                width: 100%;
            }
            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* PDF-specific styling removed - now using jsPDF */
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="text-2xl font-bold">IGNOU</div>
                    <div class="ml-2 text-sm opacity-90">Assignment Portal</div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- User Status -->
                    <div id="userStatus" class="hidden">
                        <span id="userName" class="font-medium"></span>
                        <button id="logoutBtn" class="ml-3 bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-sm transition-all">
                            Logout
                        </button>
                    </div>
                    
                    <!-- Login/Register Links -->
                    <div id="authLinks">
                        <a href="/login" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded text-sm transition-all">
                            Login
                        </a>
                        <a href="/register" class="ml-2 bg-white text-purple-600 hover:bg-opacity-90 px-4 py-2 rounded text-sm transition-all">
                            Register
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Form Section -->
        <div class="form-section" id="formSection">
            <h2 class="form-title">Student Assignment</h2>
                            <p class="form-subtitle">Please fill in all the required details (some fields are optional)</p>
            <form id="certificateForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentName" class="required">Full Name of Student</label>
                        <input type="text" id="studentName" name="studentName" required>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentNumber" class="required">Enrollment Number</label>
                        <input type="text" id="enrollmentNumber" name="enrollmentNumber" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="programSelection" class="required">Program Selection</label>
                        <select id="programSelection" name="programSelection" required>
                            <option value="">Select Program</option>
                            <option value="MBA">MBA</option>
                            <option value="BBA">BBA</option>
                            <option value="MCA">MCA</option>
                            <option value="BCA">BCA</option>
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseCode" class="required">Course Code</label>
                        <input type="text" id="courseCode" name="courseCode" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="studyCenterCode" class="required">Study Center Code</label>
                        <input type="text" id="studyCenterCode" name="studyCenterCode" required>
                    </div>
                    <div class="form-group">
                        <label for="studyCenterAddress" class="required">Name of Study Center with Complete Address</label>
                        <select id="studyCenterAddress" name="studyCenterAddress" required>
                            <option value="">Select a study center</option>
                            <option value="Kolkata Main Center">Kolkata Main Center</option>
                            <option value="Delhi Study Center">Delhi Study Center</option>
                            <option value="Mumbai Study Center">Mumbai Study Center</option>
                            <option value="Chennai Study Center">Chennai Study Center</option>
                            <option value="Bangalore Study Center">Bangalore Study Center</option>
                        </select>
                    </div>


                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Medium Selection</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="mediumEnglish" name="mediumSelection" value="English" required>
                                <label for="mediumEnglish">English</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="mediumHindi" name="mediumSelection" value="Hindi" required>
                                <label for="mediumHindi">Hindi</label>
                            </div>
                        </div>
                    </div>
                                         <div class="form-group">
                         <label for="examType" class="required">Exam Type Selection</label>
                         <div class="radio-group">
                             <div class="radio-item">
                                 <input type="radio" id="examYearly" name="examType" value="Yearly" required>
                                 <label for="examYearly">Yearly</label>
                             </div>
                             <div class="radio-item">
                                 <input type="radio" id="examSemester" name="examType" value="Semester" required>
                                 <label for="examSemester">Semester</label>
                             </div>
                         </div>
                     </div>
                     <div class="form-group" id="semesterNumberGroup" style="display: none;">
                         <label for="semesterNumber" class="required">Semester Number</label>
                         <select id="semesterNumber" name="semesterNumber">
                             <option value="">Select Semester</option>
                             <option value="1">1st Semester</option>
                             <option value="2">2nd Semester</option>
                             <option value="3">3rd Semester</option>
                             <option value="4">4th Semester</option>
                         </select>
                     </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="yearSelection" class="required">Year Selection</label>
                        <select id="yearSelection" name="yearSelection" required>
                            <option value="">Select year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="required">Subjects Selection</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectMath" name="subjects" value="Mathematics">
                                <label for="subjectMath">Mathematics</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectPhysics" name="subjects" value="Physics">
                                <label for="subjectPhysics">Physics</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectChemistry" name="subjects" value="Chemistry">
                                <label for="subjectChemistry">Chemistry</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectCS" name="subjects" value="Computer Science">
                                <label for="subjectCS">Computer Science</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectBusiness" name="subjects" value="Business Studies">
                                <label for="subjectBusiness">Business Studies</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectEnglish" name="subjects" value="English">
                                <label for="subjectEnglish">English</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="subjectEconomics" name="subjects" value="Economics">
                                <label for="subjectEconomics">Economics</label>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="mobileNumber">Mobile Number (Optional)</label>
                        <input type="tel" id="mobileNumber" name="mobileNumber">
                    </div>
                    <div class="form-group">
                        <label for="emailId">Email ID (Optional)</label>
                        <input type="email" id="emailId" name="emailId">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="idCard" class="required">Upload ID Card (JPG, PNG, WebP, AVIF)</label>
                        <input type="file" id="idCard" name="idCard" accept=".jpg,.jpeg,.png,.webp,.avif" required>
                    </div>
                    <div class="form-group">
                        <label for="signature" class="required">Upload Signature (JPG, PNG, WebP, AVIF)</label>
                        <input type="file" id="signature" name="signature" accept=".jpg,.jpeg,.png,.webp,.avif" required>
                        <!-- Hidden canvas for signature processing -->
                        <canvas id="signatureCanvas" style="display: none;"></canvas>
                        

                        

                        

                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Has the same assignment been submitted anywhere? (Optional)</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="submittedYes" name="submittedElsewhere" value="Yes">
                                <label for="submittedYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="submittedNo" name="submittedElsewhere" value="No">
                                <label for="submittedNo">No</label>
                            </div>
                        </div>
                        
                        <!-- Additional details input area (shown when Yes is selected) -->
                        <div id="submissionDetailsArea" style="display: none; margin-top: 15px;">
                            <label for="submissionDetails" style="font-size: 14px; color: #666;">Please provide details about where and when the assignment was submitted:</label>
                            <textarea id="submissionDetails" name="submissionDetails" rows="3" placeholder="Enter details about previous submission (e.g., Study Centre, Date, etc.)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; margin-top: 8px; resize: vertical;"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cross-check confirmation: "I confirm the above details are correct." (Optional)</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="confirmYes" name="confirmation" value="Yes">
                                <label for="confirmYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="confirmNo" name="confirmation" value="No">
                                <label for="confirmNo">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Generate Assignment</button>
                </div>
            </form>
        </div>

        <!-- Certificate Section - Hidden (only used for PDF generation) -->
        <div id="pdfWrapper" class="hidden">
            <div id="certificateContainer" class="w-[210mm] h-[297mm] flex items-center justify-center">
                <div class="p-10 text-center border border-gray-300 bg-white shadow-lg">
                    <div id="certificate">
                        <!-- Header Row: Logos + Title -->
                        <div class="flex justify-between items-center mb-6 w-full">
                            <img src="images/image2.jpg" alt="IGNOU Hindi Logo" class="w-[90px] h-[90px] object-contain flex-shrink-0">
                            <div class="text-center flex-1 px-4">
                                <h1 class="text-xl font-bold uppercase tracking-wide mb-2">INDIRA GANDHI NATIONAL OPEN UNIVERSITY</h1>
                                <h2 class="text-base font-bold text-red-600">Regional Centre <span id="certRegionalCentre">KOLKATA</span></h2>
                            </div>
                            <img src="images/image4.jpg" alt="IGNOU English Logo" class="w-[90px] h-[90px] object-contain flex-shrink-0">
                        </div>

                        <!-- Title Block -->
                        <div class="text-center mb-8">
                            <h3 class="text-lg font-bold underline mb-2">Format for Assignment Submission</h3>
                            <p class="text-sm text-gray-600 italic mb-1">For Term End Exam June/December <span class="border-b border-gray-400 px-2">_____</span> (Year) <span class="border-b border-gray-400 px-2">_____</span></p>
                            <p class="text-sm text-gray-600 italic">(Please read the instructions given below carefully before submitting assignments)</p>
                        </div>

                        <!-- Body Content: Two-column grid -->
                        <div class="space-y-3 mb-8 ml-8">
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">1.</span>
                                <span class="font-bold text-base w-80">Name of the Student</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudentName">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">2.</span>
                                <span class="font-bold text-base w-80">Enrollment Number</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certEnrollmentNumber">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">3.</span>
                                <span class="font-bold text-base w-80">Programme Code</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certProgramSelection">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">4.</span>
                                <span class="font-bold text-base w-80">Selected Subjects</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certSelectedSubjects">_____</span>
                            </div>
                            <p class="text-xs text-gray-600 italic ml-10 mb-4">(Use this format course-wise separately)</p>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">5.</span>
                                <span class="font-bold text-base w-80">Study Centre Code</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudyCenterCode">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">6.</span>
                                <span class="font-bold text-base w-80">Name of the Study Centre With complete address</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudyCenterAddress">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">7.</span>
                                <span class="font-bold text-base w-80">Mobile Number</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certMobileNumber">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">8.</span>
                                <span class="font-bold text-base w-80">E-mail ID</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certEmailId">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">9.</span>
                                <span class="font-bold text-base w-80">Details if this same assignment has been submitted anywhere else also</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certSubmittedElsewhere">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">10.</span>
                                <span class="font-bold text-base w-80">Above information is cross checked and it is correct: Yes/No</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certConfirmation">_____</span>
                            </div>
                        </div>

                        <!-- Footer: Date and Signature -->
                        <div class="flex justify-between items-end pt-16 border-t border-gray-300">
                            <span class="font-bold text-base">Date of Submission: <span class="border-b border-gray-400 px-2" id="certSubmissionDate">_____</span></span>
                            <div class="text-center">
                                <img id="certStudentSignature" src="" alt="Student Signature" class="w-32 h-20 object-contain border border-gray-300 hidden mb-2">
                                <span class="font-bold text-base block">(Signature of the student)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Page: Student Photo -->
                    <div class="page-break-before-always mt-8">
                        <div class="text-center">
                            <div class="flex justify-center">
                                <img id="certStudentPhoto" src="" alt="Student Photo" class="w-48 h-64 object-cover border-2 border-gray-400 rounded-lg hidden">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Download Section - New Page After Form Submission -->
        <div id="downloadPage" class="form-section hidden">
            <div class="text-center">
                <h2 class="form-title">Assignment Generated Successfully!</h2>
                <p class="form-subtitle">Choose your download option below</p>
            </div>
            
            <div class="download-options">
                <!-- Download All Subjects as ZIP -->
                <div class="download-option">
                    <h3>📦 Download All Subjects</h3>
                    <p>Get all selected subjects in a single ZIP file</p>
                    <button id="downloadAllZip" class="btn btn-primary download-all-btn">
                        📥 Download All Subjects (ZIP)
                    </button>
                </div>
                
                <!-- Individual Subject Downloads -->
                <div class="download-option">
                    <h3>📚 Individual Subject Downloads</h3>
                    <p>Download specific subject assignments</p>
                    <div id="individualSubjectButtons" class="subject-buttons">
                        <!-- Individual subject buttons will be generated here -->
                    </div>
                </div>
                
                <!-- Back to Form -->
                <div class="download-option">
                    <button id="backToForm" class="btn btn-secondary">
                        ← Back to Form
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Global variable to store the transparent signature PNG
        window.transparentSignature = null;
        
        // Remove.bg API configuration
        window.removeBgApiKey = 'px2zysgmbvcxprf'; // Stored API key
        
        // Subject to PDF mapping for automatic attachment
        const subjectPDFMapping = {
            'Mathematics': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-53-EM-2025-26.pdf',
            'Computer Science': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-54-EM-2025-26.pdf',
            'Economics': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-53-EM-2025-26.pdf',
            'Physics': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-53-EM-2025-26.pdf',
            'Chemistry': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-53-EM-2025-26.pdf',
            'Biology': 'https://raw.githubusercontent.com/payalgit933/ignou_student_Assignments/main/pdfs/BCS-53-EM-2025-26.pdf'
        };
        
        // Function to merge PDFs
        async function mergePDFs(generatedPDFBytes, subjectName) {
            try {
                console.log('Starting PDF merge process...');
                console.log('PDFLib available:', typeof PDFLib);
                console.log('Subject name:', subjectName);
                
                // Wait for PDFLib to be available
                let attempts = 0;
                while (typeof PDFLib === 'undefined' && attempts < 10) {
                    console.log(`Waiting for PDFLib to load... attempt ${attempts + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof PDFLib === 'undefined') {
                    throw new Error('PDFLib library not loaded after waiting');
                }
                
                console.log('PDFLib loaded successfully');
                
                const { PDFDocument } = PDFLib;
                console.log('PDFDocument extracted:', typeof PDFDocument);
                
                // Create a new PDF document for merging
                const mergedPdf = await PDFDocument.create();
                console.log('Merged PDF document created');
                
                // Add the generated PDF (first page)
                const generatedPdf = await PDFDocument.load(generatedPDFBytes);
                console.log('Generated PDF loaded, pages:', generatedPdf.getPageCount());
                const generatedPages = await mergedPdf.copyPages(generatedPdf, generatedPdf.getPageIndices());
                generatedPages.forEach(page => mergedPdf.addPage(page));
                console.log('Generated PDF pages added to merged document');
                
                // Get the PDF file to attach based on subject
                const pdfToAttach = subjectPDFMapping[subjectName] || 'BCS-53-EM-2025-26.pdf';
                console.log(`Attaching PDF: ${pdfToAttach} for subject: ${subjectName}`);
                console.log('Available subjects:', Object.keys(subjectPDFMapping));
                console.log('Subject mapping for this subject:', subjectPDFMapping[subjectName]);
                
                try {
                    // Fetch the subject-specific PDF
                    console.log(`Fetching PDF from: pdfs/${pdfToAttach}`);
                    const response = await fetch(`pdfs/${pdfToAttach}`);
                    console.log('Fetch response status:', response.status, response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${pdfToAttach}: ${response.status}`);
                    }
                    
                    const subjectPDFBytes = await response.arrayBuffer();
                    console.log('Subject PDF bytes received:', subjectPDFBytes.byteLength);
                    
                    const subjectPdf = await PDFDocument.load(subjectPDFBytes);
                    console.log('Subject PDF loaded, pages:', subjectPdf.getPageCount());
                    
                    // Add all pages from the subject PDF
                    const subjectPages = await mergedPdf.copyPages(subjectPdf, subjectPdf.getPageIndices());
                    subjectPages.forEach(page => mergedPdf.addPage(page));
                    
                    console.log(`Successfully merged ${subjectPages.length} pages from ${pdfToAttach}`);
                    console.log('Total pages in merged PDF:', mergedPdf.getPageCount());
                    
                } catch (error) {
                    console.warn(`Could not attach ${pdfToAttach}:`, error.message);
                    console.log('Proceeding with generated PDF only');
                }
                
                // Save the merged PDF
                console.log('Saving merged PDF...');
                const mergedPdfBytes = await mergedPdf.save();
                console.log('Merged PDF saved, size:', mergedPdfBytes.byteLength);
                return mergedPdfBytes;
                
            } catch (error) {
                console.error('PDF merging failed:', error);
                console.error('Error stack:', error.stack);
                // Return original PDF if merging fails
                return generatedPDFBytes;
            }
        }
        
        // Helper function to convert array buffer to base64
        function arrayBufferToBase64(buffer) {
            let binary = "";
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        // Remove.bg API function for professional background removal
        async function removeBackground(base64Img, apiKey) {
            if (!base64Img) return null;
            
            try {
                const base64Data = base64Img.replace(/^data:image\/\w+;base64,/, "");
                
                const formData = new FormData();
                formData.append("image_file_b64", base64Data);
                formData.append("size", "auto");
                formData.append("format", "png");
                
                const res = await fetch("https://api.remove.bg/v1.0/removebg", {
                    method: 'POST',
                    headers: {
                        "X-Api-Key": apiKey,
                    },
                    body: formData
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const arrayBuffer = await res.arrayBuffer();
                const base64Result = `data:image/png;base64,${arrayBufferToBase64(arrayBuffer)}`;
                return base64Result;
                
            } catch (err) {
                console.error("remove.bg error:", err.message);
                return base64Img; // fallback to original image
            }
        }

        // Function to convert signature to transparent PNG with better background removal
        function convertSignatureToTransparentPNG(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.getElementById("signatureCanvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = img.width;
                    canvas.height = img.height;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    let transparentPixels = 0;

                    // Adjustable threshold
                    const strongThreshold = 240; // very light (almost white) → fully transparent
                    const softThreshold = 200;  // light gray/off-white → partially transparent

                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const brightness = (r + g + b) / 3;

                        if (brightness > strongThreshold) {
                            // Pure white → fully transparent
                            data[i + 3] = 0;
                            transparentPixels++;
                        } else if (brightness > softThreshold) {
                            // Near-white → soften alpha instead of full removal
                            const fade = (brightness - softThreshold) / (strongThreshold - softThreshold);
                            data[i + 3] = data[i + 3] * (1 - fade);
                        }
                    }

                    console.log(
                        `Signature transparency processed: ${transparentPixels} pure-white pixels removed.`
                    );

                    ctx.putImageData(imageData, 0, 0);

                    // Export PNG with transparency
                    const transparentPNG = canvas.toDataURL("image/png", 1.0);
                    window.transparentSignature = transparentPNG;

                    resolve(transparentPNG);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Form submission handler
        document.getElementById('certificateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateAssignment();
        });

        // Handle exam type selection to show/hide semester number
        document.querySelectorAll('input[name="examType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const semesterGroup = document.getElementById('semesterNumberGroup');
                if (this.value === 'Semester') {
                    semesterGroup.style.display = 'block';
                    document.getElementById('semesterNumber').required = true;
                } else {
                    semesterGroup.style.display = 'none';
                    document.getElementById('semesterNumber').required = false;
                }
            });
        });

        // Handle assignment submission elsewhere selection to show/hide details input
        document.querySelectorAll('input[name="submittedElsewhere"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const detailsArea = document.getElementById('submissionDetailsArea');
                const detailsInput = document.getElementById('submissionDetails');
                
                if (this.value === 'Yes') {
                    detailsArea.style.display = 'block';
                    detailsInput.required = true;
            } else {
                    detailsArea.style.display = 'none';
                    detailsInput.required = false;
                    detailsInput.value = ''; // Clear the input when hiding
                }
            });
        });

        // Handle signature file selection to convert to transparent PNG
        document.getElementById('signature').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && (file.type.startsWith('image/'))) {
                console.log('Signature file selected:', file.name, file.type, file.size);
                
                // Automatically use remove.bg API for professional background removal
                const apiKey = window.removeBgApiKey;
                console.log('Using remove.bg API for professional background removal');
                
                // Convert file to base64 first
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Img = e.target.result;
                    console.log('Processing with remove.bg API...');
                    
                    removeBackground(base64Img, apiKey).then(transparentPNG => {
                        window.transparentSignature = transparentPNG;
                        console.log('Remove.bg processing completed successfully');
                        console.log('Professional transparent signature size:', transparentPNG.length);
                    }).catch(error => {
                        console.error('Remove.bg processing failed:', error);
                        // Fallback to local processing
                        convertSignatureToTransparentPNG(file).then(transparentPNG => {
                            console.log('Fallback to local processing successful');
                        }).catch(localError => {
                            console.error('Local processing also failed:', localError);
                        });
                    });
                };
                reader.readAsDataURL(file);
            } else {
                console.log('No valid signature file selected');
            }
        });

        // Generate assignment function - Now redirects to payment
        async function generateAssignment() {
            const formData = new FormData(document.getElementById('certificateForm'));
            
            // Get selected subjects
            const selectedSubjects = formData.getAll('subjects');
            console.log('📚 Selected subjects:', selectedSubjects); // Debug log
            
            if (selectedSubjects.length === 0) {
                alert('Please select at least one subject before proceeding to payment.');
                return;
            }
            
            // Validate required fields (all fields that will be sent to backend)
            const requiredFields = [
                'studentName', 'enrollmentNumber', 'programSelection', 'courseCode', 
                'studyCenterCode', 'studyCenterAddress', 'examType', 'yearSelection', 'mediumSelection'
            ];
            
            for (const field of requiredFields) {
                if (!formData.get(field)) {
                    alert(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return;
                }
            }
            
            // Special validation for semester number (only required if exam type is semester)
            if (formData.get('examType') === 'Semester' && !formData.get('semesterNumber')) {
                alert('Please fill in semester number');
                return;
            }
            
            // Check if ID card and signature are uploaded
            const idCard = document.getElementById('idCard').files[0];
            const signature = document.getElementById('signature').files[0];
            
            if (!idCard) {
                alert('Please upload your ID Card before proceeding.');
                return;
            }
            
            if (!signature) {
                alert('Please upload your signature before proceeding.');
                return;
            }
            
            // Show payment confirmation
            const amount = selectedSubjects.length; // ₹1 per subject
            const confirmPayment = confirm(
                `Payment Summary:\n\n` +
                `Subjects: ${selectedSubjects.join(', ')}\n` +
                `Amount: ₹${amount}\n\n` +
                `You will be redirected to Cashfree payment gateway.\n` +
                `Do you want to proceed?`
            );
            
            if (!confirmPayment) {
                return;
            }
            
            // Show loading state
            const submitButton = document.querySelector('.btn.btn-primary');
            const originalText = submitButton.textContent;
            submitButton.textContent = '⏳ Processing...';
            submitButton.disabled = true;
            
            try {
                // Prepare payment data
                const paymentData = {
                    subjects: selectedSubjects,
                    studentName: formData.get('studentName'),
                    enrollmentNumber: formData.get('enrollmentNumber'),
                    programSelection: formData.get('programSelection'),
                    courseCode: formData.get('courseCode'),
                    studyCenterCode: formData.get('studyCenterCode'),
                    studyCenterAddress: formData.get('studyCenterAddress'),
                    examType: formData.get('examType'),
                    semesterNumber: formData.get('semesterNumber'),
                    yearSelection: formData.get('yearSelection'),
                    mediumSelection: formData.get('mediumSelection')
                };
                
                // Store form data for later use after payment
                window.pendingFormData = paymentData;
                
                // Debug: Log payment data
                console.log('🔍 Payment data being sent:', paymentData);
                
                // Initiate payment
                const response = await fetch('/initiate-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                console.log('📡 Payment response status:', response.status);
                
                const result = await response.json();
                
                if (result.success) {
                    // Store transaction ID
                    window.currentTransactionId = result.transactionId;
                    
                    // Initialize Cashfree SDK
                    const cashfree = Cashfree({
                        mode: "production"
                    });
                    
                    // Open Cashfree checkout using the new SDK method
                    console.log('Opening Cashfree checkout with session ID:', result.paymentSessionId);
                    
                    let checkoutOptions = {
                        paymentSessionId: result.paymentSessionId,
                        redirectTarget: "_self"
                    };
                    
                    cashfree.checkout(checkoutOptions);
                    
                } else {
                    throw new Error(result.error || 'Payment initiation failed');
                }
                
            } catch (error) {
                console.error('Payment initiation failed:', error);
                alert(`Payment initiation failed: ${error.message}`);
                
                // Reset button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // Generate individual subject buttons for the download page
        function generateIndividualSubjectButtons(subjects) {
            console.log('Generating individual subject buttons for:', subjects);
            const container = document.getElementById('individualSubjectButtons');
            
            if (!container) {
                console.error('Individual subject buttons container not found');
                return;
            }
            
            container.innerHTML = '';
            
            subjects.forEach((subject, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'subject-btn';
                button.textContent = `📖 ${subject}`;
                button.onclick = () => downloadSingleSubject(subject);
                container.appendChild(button);
                console.log(`Created button for: ${subject}`);
            });
        }

        // Download single subject PDF
        async function downloadSingleSubject(subjectName) {
            try {
                console.log(`Downloading PDF for subject: ${subjectName}`);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '⏳ Generating...';
                button.disabled = true;
                
                // Generate and download the PDF for this specific subject
                await downloadPDF(subjectName);
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
                console.log(`PDF downloaded successfully for: ${subjectName}`);
                
            } catch (error) {
                console.error(`Failed to download PDF for ${subjectName}:`, error);
                alert(`Failed to download PDF for ${subjectName}. Please try again.`);
                
                // Reset button on error
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Download all subjects as ZIP
        async function downloadAllSubjectsZip() {
            try {
                console.log('Downloading all subjects as ZIP');
                
                // Show loading state
                const button = document.getElementById('downloadAllZip');
                const originalText = button.textContent;
                button.textContent = '⏳ Creating ZIP...';
                button.disabled = true;
                
                const subjects = window.selectedSubjects || [];
                
                if (subjects.length === 0) {
                    alert('No subjects selected. Please go back and select subjects.');
                    return;
                }
                
                // Generate PDFs for all subjects
                const pdfPromises = subjects.map(subject => downloadPDF(subject, true)); // true = return blob instead of downloading
                const pdfBlobs = await Promise.all(pdfPromises);
                
                // Create ZIP file
                const JSZip = window.JSZip;
                if (!JSZip) {
                    // If JSZip is not available, download PDFs individually
                    alert('ZIP creation not available. Downloading PDFs individually...');
                    subjects.forEach(subject => downloadPDF(subject));
                    return;
                }
                
                const zip = new JSZip();
                
                // Add each PDF to the ZIP
                subjects.forEach((subject, index) => {
                    if (pdfBlobs[index]) {
                        const fileName = `Assignment_${subject}_${new Date().toISOString().split('T')[0]}.pdf`;
                        zip.file(fileName, pdfBlobs[index]);
                    }
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `All_Subjects_Assignment_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ZIP file downloaded successfully');
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Failed to create ZIP:', error);
                alert('Failed to create ZIP file. Downloading PDFs individually...');
                
                // Fallback to individual downloads
                const subjects = window.selectedSubjects || [];
                subjects.forEach(subject => downloadPDF(subject));
                
                // Reset button
                const button = document.getElementById('downloadAllZip');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Generate download buttons for each subject
        function generateDownloadButtons(subjects) {
            console.log('Generating download buttons for subjects:', subjects);
            const downloadButtonsContainer = document.getElementById('downloadButtons');
            if (!downloadButtonsContainer) {
                console.error('Download buttons container not found');
                return;
            }
            
            downloadButtonsContainer.innerHTML = '';
            
            if (subjects.length === 0) {
                // If no subjects selected, create one general download button
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-secondary w-full';
                button.textContent = 'Download PDF';
                button.onclick = () => downloadPDF('student_assignment');
                downloadButtonsContainer.appendChild(button);
                console.log('Created general download button');
            } else {
                // Create separate download button for each subject
                subjects.forEach((subject, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-secondary w-full';
                    button.textContent = `Download PDF - ${subject}`;
                    button.onclick = () => downloadPDF(subject);
                    downloadButtonsContainer.appendChild(button);
                    console.log(`Created download button for: ${subject}`);
                });
            }
        }

        // Download PDF function using jsPDF
        async function downloadPDF(subjectName = 'student_assignment', returnBlob = false) {
            try {
                // Get form data for the current subject
                const formData = new FormData(document.getElementById('certificateForm'));
                
                // Prepare template data
                const templateData = {
                    name: formData.get('studentName') || 'Not provided',
                    enrollment: formData.get('enrollmentNumber') || 'Not provided',
                    program: formData.get('programSelection') || 'Not provided',
                    courseCode: formData.get('courseCode') || 'Not provided',
                    course: subjectName === 'student_assignment' ? 
                        (formData.getAll('subjects').length > 0 ? formData.getAll('subjects').join(', ') : 'Not provided') : 
                        subjectName,
                    centerCode: formData.get('studyCenterCode') || 'Not provided',
                    centerAddress: formData.get('studyCenterAddress') || 'Not provided',
                    center: formData.get('studyCenterAddress') ? 
                        formData.get('studyCenterAddress').split(' ')[0] : 'Delhi',
                    mobile: formData.get('mobileNumber') || 'Not provided',
                    email: formData.get('emailId') || 'Not provided',
                    assignmentAnyWhereElse: (() => {
                        const submittedElsewhere = formData.get('submittedElsewhere');
                        const submissionDetails = formData.get('submissionDetails');
                        
                        if (submittedElsewhere === 'Yes' && submissionDetails) {
                            return `Yes - ${submissionDetails}`;
                        } else {
                            return submittedElsewhere || 'Not provided';
                        }
                    })(),
                    crossChecked: formData.get('confirmation') || 'Not provided',
                    date: new Date().toLocaleDateString('en-GB') || 'Not provided',
                    semester: formData.get('semesterNumber') || '',
                    year: formData.get('yearSelection') || '',
                    photo: null,
                    sign: null
                };

                // Handle photo upload
                const photoFile = formData.get('idCard');
                if (photoFile && photoFile.size > 0) {
                    try {
                        const photoDataUrl = await fileToDataURL(photoFile);
                        templateData.photo = photoDataUrl;
                    } catch (e) {
                        console.warn("Photo conversion failed:", e);
                    }
                }

                // Handle signature upload - use transparent signature if available
                if (window.transparentSignature) {
                    console.log('Using transparent signature for PDF');
                    templateData.sign = window.transparentSignature;
                } else {
                    console.log('No transparent signature available, using fallback');
                    // Fallback to original signature processing
                const signatureFile = formData.get('signature');
                if (signatureFile && signatureFile.size > 0) {
                    try {
                        const signatureDataUrl = await fileToDataURL(signatureFile);
                        templateData.sign = signatureDataUrl;
                    } catch (e) {
                        console.warn("Signature conversion failed:", e);
                        }
                    }
                }

                // Generate PDF with logo preparation
                if (returnBlob) {
                    const blob = await prepareAndDownloadPDF(templateData, true);
                    return blob;
                } else {
                    await prepareAndDownloadPDF(templateData, false);
                    console.log("PDF generation initiated for:", subjectName);
                }
                
            } catch (error) {
                console.error("PDF generation failed:", error);
                if (returnBlob) {
                    return null;
                }
                alert("PDF generation failed. Please try again.");
            }
        }

        // Helper function to convert file to data URL
        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                // For image files, use regular FileReader
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                } else {
                    // For non-image files, use regular FileReader
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }
            });
        }

        // Convert image file to Base64
        function getBase64FromImageUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg"));
                };
                img.onerror = (err) => reject(err);
                img.src = url;
            });
        }

        async function prepareAndDownloadPDF(templateData, returnBlob = false) {
            try {
                // Generate PDF directly (logos are handled statically in generatePDF)
                return await generatePDF(templateData, returnBlob);
            } catch (e) {
                console.error("Failed to prepare PDF data:", e);
                if (returnBlob) {
                    return null;
                }
                alert("PDF preparation failed. Please try again.");
            }
        }

        // Main PDF generation function using jsPDF
        async function generatePDF(templateData, returnBlob = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt", format: "a4" });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 50;
            const lineHeight = 24;
            const maxWidth = pageWidth - margin * 2;

            // Outer border
            doc.setLineWidth(1);
            doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);

            // IGNOU Logos (left + right) - Always display first
            try {
                // Hindi Logo (image2) - left side - Moved lower
                doc.addImage("https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image2.jpg", "JPEG", margin - 15, margin + 15, 100, 40);
                // English Logo (image4) - right side - Smaller size and moved lower
                doc.addImage("https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image4.jpg", "JPEG", pageWidth - margin - 75, margin + 15, 80, 35);
            } catch (e) {
                console.warn("IGNOU logo loading failed:", e);
                // Fallback text if images fail
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text("IGNOU Logo (Hindi)", margin - 15, margin + 35);
                doc.text("IGNOU Logo (English)", pageWidth - margin - 75, margin + 30);
            }

            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("INDIRA GANDHI NATIONAL OPEN UNIVERSITY", pageWidth / 2, margin + 35, { align: "center" });

            doc.setFontSize(11);
            doc.setTextColor(200, 0, 0);
            doc.text(`Regional Centre ${templateData.center || "Delhi"}`, pageWidth / 2, margin + 55, { align: "center" });
            doc.setTextColor(0, 0, 0);

            // Title
            doc.setFontSize(14);
            doc.text("Format for Assignment Submission", pageWidth / 2, margin + 95, { align: "center" });
            doc.line(pageWidth / 2 - 120, margin + 98, pageWidth / 2 + 120, margin + 98);

            // Exam info and instructions
            doc.setFontSize(11);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100, 100, 100);
            
            // Dynamic exam info based on semester and year
            let examMonth = "June/Dec";
            let specificMonth = "_______";
            if (templateData.semester && templateData.semester !== "") {
                if (["1", "3"].includes(templateData.semester)) {
                    examMonth = "June/Dec";
                    specificMonth = "June";
                } else if (["2", "4"].includes(templateData.semester)) {
                    examMonth = "June/Dec";
                    specificMonth = "Dec";
                }
            }
            
            doc.text(`For Term End Exam ${examMonth} - ${specificMonth} Year - ${templateData.year || "_______"}`, pageWidth / 2, margin + 115, { align: "center" });
            doc.text("(Please read the instructions given below carefully before submitting assignments)", pageWidth / 2, margin + 135, { align: "center" });
            
            // Reset text color and font
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");

            let y = margin + 200;

                        // Row helper
            function addRow(num, label, value) {
                const leftX = margin + 10;
                const labelWidth = 240; // Fixed width for left column
                const valueWidth = maxWidth - 260; // Remaining width for right column
                
                doc.setFont("helvetica", "bold");
                const labelText = `${num}. ${label} : `;
                const wrappedLabel = doc.splitTextToSize(labelText, labelWidth); // wrap label if needed
                doc.text(wrappedLabel, leftX, y);
                
                doc.setFont("helvetica", "normal");
                const wrappedValue = doc.splitTextToSize(value || "__________", valueWidth); // wrap value
                
                // Draw first line of value aligned with the label
                if (wrappedValue.length > 0) {
                    doc.text(wrappedValue[0], leftX + 250, y);
                }
                
                // Draw remaining lines aligned with the label text (not the number)
                for (let i = 1; i < wrappedValue.length; i++) {
                    doc.text(wrappedValue[i], leftX + 250, y + (i * lineHeight));
                }
                
                // Move Y based on tallest block
                const lines = Math.max(wrappedLabel.length, wrappedValue.length);
                y += lineHeight * lines + 6;
                
                // Add small text below row 5 (Course Code)
                if (num === 5) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text("(Use this format course-wise separately)", leftX + 18, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "normal");
                    y += 20; // Add extra space for the small text
                }
                
                // Add additional text below row 9 if "Yes" is selected
                if (num === 9 && value.toLowerCase().includes('yes')) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text("(Please provide details in the space below)", leftX + 20, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "normal");
                    y += 15; // Add extra space for the additional text
                                     }
            }

                         // Rows
             addRow(1, "Name of the Student", templateData.name);
             addRow(2, "Enrollment Number", templateData.enrollment);
             addRow(3, "Programme Code", templateData.program);
             addRow(4, "Course Code", templateData.course);
             addRow(5, "Course Code", templateData.courseCode);
             addRow(6, "Name of the Study Centre With complete address", templateData.centerAddress);
             addRow(7, "Study Centre Code", templateData.centerCode);
             addRow(8, "Mobile Number", templateData.mobile);
             addRow(9, "Details if this same assignment has been submitted anywhere else also", templateData.assignmentAnyWhereElse);
             addRow(10, "Email ID", templateData.email);
             addRow(11, "Above information cross checked and correct?", templateData.crossChecked);

            // Footer – Date inline
            const footerY = 780;
            const signLabelY = footerY - 40; // Moved up by 40 points
            
            doc.setFont("helvetica", "bold");
            doc.text("Date of Submission:", margin, signLabelY);
            doc.setFont("helvetica", "normal");
            doc.text(templateData.date || "__________", margin + 130, signLabelY);

                         // Footer – Signature (image above text)
             if (templateData.sign) {
                 try {
                     console.log('Adding signature to PDF:', templateData.sign.substring(0, 100) + '...');
                     
                     // For signatures, always use PNG format for transparency
                     let imageFormat = "PNG";
                     
                     // Signature image: 100px × 40px above the text - moved up
                     doc.addImage(templateData.sign, imageFormat, pageWidth - margin - 120, signLabelY - 50, 100, 40);
                     console.log('Signature added to PDF successfully');
                 } catch (e) {
                     console.warn("Signature image failed:", e);
                 }
             } else {
                 console.log('No signature data available for PDF');
             }
            doc.setFont("helvetica", "bold");
            doc.text("Signature of the Student", pageWidth - margin - 120, signLabelY);

            // PAGE 2: Student Photo
            if (templateData.photo) {
                doc.addPage();
                
                // Add the same border as first page
                doc.setLineWidth(1);
                doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);
                
                                 try {
                     // Detect image format from data URL
                     let imageFormat = "JPEG";
                     if (templateData.photo.startsWith("data:image/png")) {
                         imageFormat = "PNG";
                     } else if (templateData.photo.startsWith("data:image/webp")) {
                         imageFormat = "WEBP";
                     } else if (templateData.photo.startsWith("data:image/avif")) {
                         imageFormat = "AVIF";
                     }
                     
                     // Set fixed dimensions for the photo
                     const photoWidth = 400;  // Fixed width
                     const photoHeight = 300; // Fixed height
                     
                     // Center the image on the page
                     const x = (pageWidth - photoWidth) / 2;
                     const y = (pageHeight - photoHeight) / 2;
                     
                     doc.addImage(templateData.photo, imageFormat, x, y, photoWidth, photoHeight);
                 } catch (e) {
                     console.warn("Photo addImage failed", e);
                 }
            }

            // Save file with merging - Format: <enrollment_subject>
            const enrollment = templateData.enrollment || "Student";
            const subject = templateData.course || "General";
            const fileName = `${enrollment}_${subject}.pdf`;
            
            // Get the PDF as bytes for merging
            const pdfBytes = doc.output('arraybuffer');
            
            // Merge with subject-specific PDF
            const subjectName = templateData.course || 'General';
            console.log(`Merging PDF for subject: ${subjectName}`);
            console.log('Template data course:', templateData.course);
            console.log('Template data keys:', Object.keys(templateData));
            
            try {
                console.log('Calling mergePDFs function...');
                const mergedPDFBytes = await mergePDFs(pdfBytes, subjectName);
                console.log('Merge completed, merged PDF size:', mergedPDFBytes.byteLength);
                
                // Create download link for merged PDF
                const blob = new Blob([mergedPDFBytes], { type: 'application/pdf' });
                
                if (returnBlob) {
                    // Return blob for ZIP creation
                    return blob;
                }
                
                // Download the PDF
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Merged PDF downloaded successfully');
                
            } catch (error) {
                console.error('PDF merging failed, downloading original:', error);
                console.error('Error details:', error.message);
                
                if (returnBlob) {
                    // Return original PDF blob for ZIP creation
                    const originalBlob = new Blob([doc.output('arraybuffer')], { type: 'application/pdf' });
                    return originalBlob;
                }
                
                // Fallback to original PDF if merging fails
                doc.save(fileName);
            }
        }

        // Test PDF accessibility function
        async function testPDFAccess() {
            console.log('Testing PDF accessibility...');
            const testFiles = ['BCS-53-EM-2025-26.pdf', 'BCS-54-EM-2025-26.pdf'];
            
            for (const file of testFiles) {
                try {
                    const response = await fetch(`pdfs/${file}`);
                    console.log(`${file}: Status ${response.status}, OK: ${response.ok}`);
                    if (response.ok) {
                        const bytes = await response.arrayBuffer();
                        console.log(`${file}: Size ${bytes.byteLength} bytes`);
                    }
                } catch (error) {
                    console.error(`${file}: Error -`, error.message);
                }
            }
        }
        
        // Test PDF access on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, testing PDF accessibility...');
            testPDFAccess();
        });

        // Set default date to today
        document.getElementById('yearSelection').value = new Date().getFullYear().toString();

        // Helper function to get enrollment number
        function getEnrollmentNumber() {
            return window.formData?.get('enrollmentNumber') || 'Student';
        }

        // Add event listeners for download page buttons
        document.getElementById('downloadAllZip').addEventListener('click', downloadAllSubjectsZip);
        document.getElementById('backToForm').addEventListener('click', function() {
            // Hide download page and show form
            document.getElementById('downloadPage').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        });

        // User authentication functions
        function checkAuthStatus() {
            const userData = localStorage.getItem('userData');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (userData && isLoggedIn === 'true') {
                try {
                    const user = JSON.parse(userData);
                    showUserStatus(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    clearUserData();
                }
            } else {
                showAuthLinks();
            }
        }

        function showUserStatus(user) {
            document.getElementById('userStatus').classList.remove('hidden');
            document.getElementById('authLinks').classList.add('hidden');
            document.getElementById('userName').textContent = `Welcome, ${user.name}`;
        }

        function showAuthLinks() {
            document.getElementById('userStatus').classList.add('hidden');
            document.getElementById('authLinks').classList.remove('hidden');
        }

        function clearUserData() {
            localStorage.removeItem('userData');
            localStorage.removeItem('isLoggedIn');
            showAuthLinks();
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    clearUserData();
                    // Redirect to login page
                    window.location.href = '/login';
                } else {
                    console.error('Logout failed');
                    clearUserData();
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
                clearUserData();
                window.location.href = '/login';
            }
        });

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });
    </script>
</body>
</html>
