<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Assignment Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .form-section {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease-out;
        }

        .form-section.hidden {
            display: none;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-title {
            text-align: center;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 40px;
            font-size: 18px;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group.full-width {
            flex: 1 1 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }

        .form-group label.required::after {
            content: " *";
            color: #e74c3c;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
        }

        .form-group input[type="file"] {
            padding: 16px 20px;
            border: 2px dashed #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .form-group input[type="file"]:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: #7c3aed;
        }

        .courses-dropdown {
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .courses-dropdown option {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .courses-dropdown option:hover {
            background-color: #f3f4f6;
        }

        .courses-dropdown option:checked {
            background-color: #8b5cf6;
            color: white;
        }

        .selected-courses-display {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            min-height: 40px;
        }

        .selected-course-tag {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 2px 4px 2px 0;
            font-weight: 500;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .radio-item label {
            margin: 0;
            font-weight: normal;
            color: #333;
        }

        .selected-subjects {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #4CAF50;
        }

        .selected-subjects strong {
            color: #2e7d32;
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            padding: 18px 40px;
            margin: 0 10px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary { 
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-secondary { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        /* Modal/Overlay Styling */
        #confirmOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        #confirmModal {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideInModal 0.4s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #confirmHeader {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 24px 32px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin: 0;
        }

        #confirmBody {
            padding: 32px;
            font-size: 16px;
            line-height: 1.6;
            color: #374151;
            text-align: center;
            white-space: pre-line;
        }

        #confirmActions {
            padding: 0 32px 32px 32px;
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        #confirmActions .btn {
            padding: 12px 24px;
            margin: 0;
            font-size: 16px;
            min-width: 120px;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #e5e7eb;
            color: #6b7280;
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInModal {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Toast Styling */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #8b5cf6;
            min-width: 300px;
            animation: slideInToast 0.3s ease-out;
            transition: all 0.3s ease;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast .title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .toast .msg {
            color: #6b7280;
            font-size: 14px;
        }

        @keyframes slideInToast {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .certificate {
            background: white;
            padding: 40px;
            margin: 0;
            border: 1px solid #000000;
            font-family: Arial, sans-serif;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
        }

        .certificate-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .university-name {
            font-size: 20px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .regional-center {
            font-family: Calibri, sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #FF0000;
            margin-bottom: 0;
            text-decoration: none;
        }

        .certificate-title {
            font-size: 18px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
            margin-left: 0;
        }

        .logo-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
            padding: 0;
            gap: 0;
            width: 100%;
            margin-left: -20px;
        }

        .logo-section img {
            width: 130px;
            height: 130px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .header-text {
            text-align: center;
            flex: 1;
            margin: 0 5px;
            width: 100%;
        }

        .certificate-content {
            margin: 15px 0;
        }
        
        /* A4 specific adjustments */
        @page {
            size: A4;
            margin: 15mm;
        }

        .info-row {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
        }

        .info-label {
            font-weight: bold;
            color: #333;
            min-width: 200px;
            font-size: 16px;
        }

        .info-value {
            color: #666;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding: 5px 10px;
            min-width: 300px;
        }

        .signature-section {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .signature-box {
            text-align: center;
            flex: 1;
        }

        .signature-line {
            width: 200px;
            height: 2px;
            background-color: #333;
            margin: 10px auto;
        }

        .date-section {
            text-align: center;
            margin-top: 40px;
        }

        .photo-placeholder {
            width: 120px;
            height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            margin: 20px auto;
            page-break-before: always;
        }

        .exam-info {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
            margin-left: 0;
        }

        .instructions {
            text-align: center;
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
            margin-left: 0;
        }

        .assignment-details {
            margin: 10px 0;
            margin-left: 0;
        }

        .detail-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 15px;
        }

        .detail-number {
            font-weight: bold;
            color: #000000;
            min-width: 25px;
            margin-right: 8px;
        }

        .detail-label {
            font-weight: bold;
            color: #000000;
            min-width: 280px;
            margin-right: 8px;
        }

        .detail-separator {
            color: #000000;
            margin-right: 8px;
        }

        .detail-value {
            color: #000000;
            padding: 2px 8px;
            min-width: 180px;
        }

        .course-note {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin: 5px 0 15px 33px;
        }

        .submission-section {
            margin-top: 60px;
            padding-top: 20px;
        }

        .date-signature-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0;
        }

        .date-label {
            font-weight: bold;
            color: #000000;
        }

        .date-value {
            color: #000000;
            padding: 2px 8px;
            min-width: 100px;
        }

        .signature-label {
            color: #000000;
            font-weight: bold;
        }

        /* Hidden canvas for signature processing */
        #signatureCanvas {
            display: none;
        }



        .download-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .download-section h3 {
            margin-bottom: 20px;
            color: #333;
        }

        /* Download Page Styles */
        .download-options {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 30px;
        }

        .download-option {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            text-align: center;
            transition: all 0.3s ease;
        }

        .download-option:hover {
            border-color: #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .download-option h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .download-option p {
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .subject-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .subject-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .subject-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .download-all-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            font-size: 18px;
            padding: 20px 30px;
            min-width: 300px;
        }

        .download-all-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
        }

        @media print {
            .form-section, .button-group, .download-section {
                display: none;
            }
            .certificate {
                box-shadow: none;
                border: 1px solid #000000;
                margin: 0;
                padding: 40px;
                width: 210mm;
                height: 297mm;
                page-break-after: always;
            }
            
            body {
                margin: 0;
                padding: 0;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .certificate {
                padding: 30px;
                margin: 40px;
            }
            .logo-section img {
                width: 110px;
                height: 110px;
            }
            .university-name {
                font-size: 16px;
            }
            .regional-center {
                font-size: 14px;
            }
            .detail-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .detail-label {
                min-width: auto;
                margin-bottom: 5px;
            }
            .detail-value {
                min-width: auto;
                width: 100%;
            }
            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* PDF-specific styling removed - now using jsPDF */
    </style>
</head>
<body>
    <div class="container">
        <!-- Form Section -->
        <div class="form-section" id="formSection">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h2 class="form-title">Student Assignment Form</h2>
                <p class="form-subtitle">Please fill in all the required details to generate your assignment</p>
            </div>
            <form id="certificateForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentName" class="required">Full Name of Student</label>
                        <input type="text" id="studentName" name="studentName" required>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentNumber" class="required">Enrollment Number</label>
                        <input type="text" id="enrollmentNumber" name="enrollmentNumber" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="programSelection" class="required">Program Selection</label>
                        <select id="programSelection" name="programSelection" required>
                            <option value="">Select Program</option>
                            <option value="MBA">MBA</option>
                            <option value="BBA">BBA</option>
                            <option value="MCA">MCA</option>
                            <option value="BCA">BCA</option>
                            <option value="B.Tech">B.Tech</option>
                            <option value="M.Tech">M.Tech</option>
                        </select>
                    </div>
                    
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="studyCenterCode" class="required">Study Center Code</label>
                        <input type="text" id="studyCenterCode" name="studyCenterCode" required>
                            </div>
                    <div class="form-group">
                        <label for="studyCenterAddress" class="required">Name of Study Center with Complete Address</label>
                        <select id="studyCenterAddress" name="studyCenterAddress" required>
                            <option value="">Select a study center</option>
                            <option value="Kolkata Main Center">Kolkata Main Center</option>
                            <option value="Delhi Study Center">Delhi Study Center</option>
                            <option value="Mumbai Study Center">Mumbai Study Center</option>
                            <option value="Chennai Study Center">Chennai Study Center</option>
                            <option value="Bangalore Study Center">Bangalore Study Center</option>
                        </select>
                    </div>


                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Medium Selection</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="mediumEnglish" name="mediumSelection" value="English" required>
                                <label for="mediumEnglish">English</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="mediumHindi" name="mediumSelection" value="Hindi" required>
                                <label for="mediumHindi">Hindi</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                         <label for="examType" class="required">Exam Type Selection</label>
                         <div class="radio-group">
                             <div class="radio-item">
                                 <input type="radio" id="examYearly" name="examType" value="Yearly" required>
                                 <label for="examYearly">Yearly</label>
                    </div>
                             <div class="radio-item">
                                 <input type="radio" id="examSemester" name="examType" value="Semester" required>
                                 <label for="examSemester">Semester</label>
                             </div>
                         </div>
                     </div>
                     <div class="form-group" id="semesterNumberGroup" style="display: none;">
                         <label for="semesterNumber" class="required">Semester Number</label>
                         <select id="semesterNumber" name="semesterNumber">
                             <option value="">Select Semester</option>
                             <option value="1">1st Semester</option>
                             <option value="2">2nd Semester</option>
                             <option value="3">3rd Semester</option>
                             <option value="4">4th Semester</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="yearSelection" class="required">Year Selection</label>
                        <select id="yearSelection" name="yearSelection" required>
                            <option value="">Select year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label class="required">Courses Selection</label>
                        <div id="coursesSelectContainer">
                            <div style="margin-bottom:8px;">
                                <label style="font-weight:normal;"><input type="checkbox" id="selectAllCourses"> Select All</label>
                            </div>
                            <div id="coursesCheckboxes" class="checkbox-group">
                                <div>No courses available. Select Program, Exam Type and Year/Sem first</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="mobileNumber" class="required">Mobile Number</label>
                        <input type="tel" id="mobileNumber" name="mobileNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="emailId" class="required">Email ID</label>
                        <input type="email" id="emailId" name="emailId" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="idCard" class="required">Upload ID Card (JPG, PNG, WebP, AVIF)</label>
                        <input type="file" id="idCard" name="idCard" accept=".jpg,.jpeg,.png,.webp,.avif" required>
                    </div>
                    <div class="form-group">
                        <label for="signature" class="required">Upload Signature (JPG, PNG, WebP, AVIF)</label>
                        <input type="file" id="signature" name="signature" accept=".jpg,.jpeg,.png,.webp,.avif" required>
                        <!-- Hidden canvas for signature processing -->
                        <canvas id="signatureCanvas" style="display: none;"></canvas>
                        

                        

                        

                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Has the same assignment been submitted anywhere?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="submittedYes" name="submittedElsewhere" value="Yes" required>
                                <label for="submittedYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="submittedNo" name="submittedElsewhere" value="No" required>
                                <label for="submittedNo">No</label>
                            </div>
                        </div>
                        
                        <!-- Additional details input area (shown when Yes is selected) -->
                        <div id="submissionDetailsArea" style="display: none; margin-top: 15px;">
                            <label for="submissionDetails" style="font-size: 14px; color: #666;">Please provide details about where and when the assignment was submitted:</label>
                            <textarea id="submissionDetails" name="submissionDetails" rows="3" placeholder="Enter details about previous submission (e.g., Study Centre, Date, etc.)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; margin-top: 8px; resize: vertical;"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required">Cross-check confirmation: "I confirm the above details are correct."</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="confirmYes" name="confirmation" value="Yes" required>
                                <label for="confirmYes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="confirmNo" name="confirmation" value="No" required>
                                <label for="confirmNo">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Pay & Generate Assignment
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Certificate Section - Hidden (only used for PDF generation) -->
        <div id="pdfWrapper" class="hidden">
            <div id="certificateContainer" class="w-[210mm] h-[297mm] flex items-center justify-center">
                <div class="p-10 text-center border border-gray-300 bg-white shadow-lg">
                    <div id="certificate">
                        <!-- Header Row: Logos + Title -->
                        <div class="flex justify-between items-center mb-6 w-full">
                            <img src="https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image2.jpg" alt="IGNOU Hindi Logo" class="w-[90px] h-[90px] object-contain flex-shrink-0">
                            <div class="text-center flex-1 px-4">
                                <h1 class="text-xl font-bold uppercase tracking-wide mb-2">INDIRA GANDHI NATIONAL OPEN UNIVERSITY</h1>
                                <h2 class="text-base font-bold text-red-600">Regional Centre <span id="certRegionalCentre">KOLKATA</span></h2>
                            </div>
                            <img src="https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image4.jpg" alt="IGNOU English Logo" class="w-[90px] h-[90px] object-contain flex-shrink-0">
                        </div>

                        <!-- Title Block -->
                        <div class="text-center mb-8">
                            <h3 class="text-lg font-bold underline mb-2">Format for Assignment Submission</h3>
                            <p class="text-sm text-gray-600 italic mb-1">For Term End Exam June/December <span class="border-b border-gray-400 px-2">_____</span> (Year) <span class="border-b border-gray-400 px-2">_____</span></p>
                            <p class="text-sm text-gray-600 italic">(Please read the instructions given below carefully before submitting assignments)</p>
                        </div>

                        <!-- Body Content: Two-column grid -->
                        <div class="space-y-3 mb-8 ml-8">
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">1.</span>
                                <span class="font-bold text-base w-80">Name of the Student</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudentName">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">2.</span>
                                <span class="font-bold text-base w-80">Enrollment Number</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certEnrollmentNumber">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">3.</span>
                                <span class="font-bold text-base w-80">Programme Code</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certProgramSelection">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">4.</span>
                                <span class="font-bold text-base w-80">Course Code</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certCourseCode">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">5.</span>
                                <span class="font-bold text-base w-80">Selected Courses</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certSelectedCourses">_____</span>
                            </div>
                            <p class="text-xs text-gray-600 italic ml-10 mb-4">(Use this format course-wise separately)</p>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">6.</span>
                                <span class="font-bold text-base w-80">Study Centre Code</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudyCenterCode">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">7.</span>
                                <span class="font-bold text-base w-80">Name of the Study Centre With complete address</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certStudyCenterAddress">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">8.</span>
                                <span class="font-bold text-base w-80">Mobile Number</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certMobileNumber">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">9.</span>
                                <span class="font-bold text-base w-80">E-mail ID</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certEmailId">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">10.</span>
                                <span class="font-bold text-base w-80">Details if this same assignment has been submitted anywhere else also</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certSubmittedElsewhere">_____</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-bold text-base w-8">11.</span>
                                <span class="font-bold text-base w-80">Above information is cross checked and it is correct: Yes/No</span>
                                <span class="text-base mx-2">:</span>
                                <span class="text-base border-b border-gray-400 px-2" id="certConfirmation">_____</span>
                            </div>
                        </div>

                        <!-- Footer: Date and Signature -->
                        <div class="flex justify-between items-end pt-16 border-t border-gray-300">
                            <span class="font-bold text-base">Date of Submission: <span class="border-b border-gray-400 px-2" id="certSubmissionDate">_____</span></span>
                            <div class="text-center">
                                <img id="certStudentSignature" src="" alt="Student Signature" class="w-32 h-20 object-contain border border-gray-300 hidden mb-2">
                                <span class="font-bold text-base block">(Signature of the student)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Page: Student Photo -->
                    <div class="page-break-before-always mt-8">
                        <div class="text-center">
                            <div class="flex justify-center">
                                <img id="certStudentPhoto" src="" alt="Student Photo" class="w-48 h-64 object-cover border-2 border-gray-400 rounded-lg hidden">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Download Section - New Page After Form Submission -->
        <div id="downloadPage" class="form-section hidden">
            <div class="text-center">
                <h2 class="form-title">Assignment Generated Successfully!</h2>
                <p class="form-subtitle">Choose your download option below</p>
            </div>
            
            <div class="download-options">
                <!-- Download All Courses as ZIP -->
                <div class="download-option">
                    <h3>📦 Download All Courses</h3>
                    <p>Get all selected courses in a single ZIP file</p>
                    <button id="downloadAllZip" class="btn btn-primary download-all-btn">
                        📥 Download All Courses (ZIP)
                    </button>
                </div>
                
                <!-- Individual Course Downloads -->
                <div class="download-option">
                    <h3>📚 Individual Course Downloads</h3>
                    <p>Download specific course assignments</p>
                    <div id="individualCourseButtons" class="subject-buttons">
                        <!-- Individual course buttons will be generated here -->
                    </div>
                </div>
                
                <!-- Back to Form -->
                <div class="download-option">
                    <button id="backToForm" class="btn btn-secondary">
                        ← Back to Form
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div id="toastContainer"></div>
    <div id="confirmOverlay">
        <div id="confirmModal">
            <div id="confirmHeader">Please Confirm</div>
            <div id="confirmBody"></div>
            <div id="confirmActions">
                <button id="confirmCancel" class="btn btn-outline">Cancel</button>
                <button id="confirmOk" class="btn btn-danger">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Global variable to store the transparent signature PNG
        window.transparentSignature = null;
        
        // Remove.bg API configuration
        window.removeBgApiKey = 'px2zysgmbvcxprf'; // Stored API key
        
        // Populate dynamic Courses checkboxes based on Program + Exam Type + Year/Sem
        function updateCoursesSelect() {
            const program = document.getElementById('programSelection').value;
            const examType = (document.querySelector('input[name="examType"]:checked') || {}).value || '';
            const year = document.getElementById('yearSelection').value;
            const semester = document.getElementById('semesterNumber').value;
            const container = document.getElementById('coursesCheckboxes');
            const selectAll = document.getElementById('selectAllCourses');
            
            console.log('updateCoursesSelect called:', { program, examType, year, semester });
            console.log('courseCodes available:', Object.keys(courseCodes));
            
            if (!container) {
                console.error('Courses checkboxes container not found!');
                return;
            }
            
            // Clear existing checkboxes
            container.innerHTML = '';
            
            // Simplified logic: only require program to show courses
            if (!program) {
                const msg = document.createElement('div');
                msg.textContent = 'Please select a Program first';
                container.appendChild(msg);
                return;
            }
            
            const list = courseCodes[program] || [];
            console.log('Found courses for program', program, ':', list.length, 'courses');
            
            if (list.length === 0) {
                const msg = document.createElement('div');
                msg.textContent = 'No courses available for selected program';
                container.appendChild(msg);
                return;
            }
            
            // Populate checkboxes with courses
            console.log('Populating checkboxes with courses:', list.length, 'courses');
            list.forEach((item, index) => {
                const wrapper = document.createElement('label');
                wrapper.className = 'checkbox-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'courses';
                input.value = item.value;
                const span = document.createElement('span');
                span.textContent = item.text;
                wrapper.appendChild(input);
                wrapper.appendChild(span);
                container.appendChild(wrapper);
                console.log(`Added checkbox ${index + 1}:`, item.value, item.text);
            });

            // Select All binding
            if (selectAll) {
                selectAll.checked = false;
                selectAll.onchange = function() {
                    const checks = container.querySelectorAll('input[type="checkbox"][name="courses"]');
                    checks.forEach(c => c.checked = selectAll.checked);
                };
            }
            
            console.log('Courses checkboxes populated successfully with', list.length, 'options');
        }

        
        // Function to merge PDFs
        async function mergePDFs(generatedPDFBytes, courseName) {
            try {
                console.log('Starting PDF merge process...');
                console.log('PDFLib available:', typeof PDFLib);
                console.log('Course name:', courseName);
                
                // Wait for PDFLib to be available
                let attempts = 0;
                while (typeof PDFLib === 'undefined' && attempts < 10) {
                    console.log(`Waiting for PDFLib to load... attempt ${attempts + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof PDFLib === 'undefined') {
                    throw new Error('PDFLib library not loaded after waiting');
                }
                
                console.log('PDFLib loaded successfully');
                
                const { PDFDocument } = PDFLib;
                console.log('PDFDocument extracted:', typeof PDFDocument);
                
                // Create a new PDF document for merging
                const mergedPdf = await PDFDocument.create();
                console.log('Merged PDF document created');
                
                // Add the generated PDF (first page)
                const generatedPdf = await PDFDocument.load(generatedPDFBytes);
                console.log('Generated PDF loaded, pages:', generatedPdf.getPageCount());
                const generatedPages = await mergedPdf.copyPages(generatedPdf, generatedPdf.getPageIndices());
                generatedPages.forEach(page => mergedPdf.addPage(page));
                console.log('Generated PDF pages added to merged document');
                
                // Try to attach a local PDF by course code (works offline like working/index.html)
                const pdfCandidates = [
                    `pdfs/MBA/${courseName}.pdf`,
                    `pdfs/${courseName}.pdf`,
                ];
                let attached = false;
                for (const candidate of pdfCandidates) {
                    try {
                        console.log(`Attempting to fetch PDF: ${candidate}`);
                        const resp = await fetch(candidate, { method: 'GET' });
                        if (!resp.ok) {
                            console.log(`Not found or inaccessible: ${candidate} → status ${resp.status}`);
                            continue;
                        }
                        const subjectPDFBytes = await resp.arrayBuffer();
                    console.log('Subject PDF bytes received:', subjectPDFBytes.byteLength);
                    const subjectPdf = await PDFDocument.load(subjectPDFBytes);
                    console.log('Subject PDF loaded, pages:', subjectPdf.getPageCount());
                    const subjectPages = await mergedPdf.copyPages(subjectPdf, subjectPdf.getPageIndices());
                    subjectPages.forEach(page => mergedPdf.addPage(page));
                        console.log(`Successfully merged ${subjectPages.length} pages from ${candidate}`);
                        attached = true;
                        break;
                    } catch (err) {
                        console.warn(`Failed to attach from ${candidate}:`, err.message);
                    }
                }
                if (!attached) {
                    console.log('No subject PDF attached; proceeding with generated PDF only');
                }
                
                // Save the merged PDF
                console.log('Saving merged PDF...');
                const mergedPdfBytes = await mergedPdf.save();
                console.log('Merged PDF saved, size:', mergedPdfBytes.byteLength);
                return mergedPdfBytes;
                
            } catch (error) {
                console.error('PDF merging failed:', error);
                console.error('Error stack:', error.stack);
                // Return original PDF if merging fails
                return generatedPDFBytes;
            }
        }
        
        // Helper function to convert array buffer to base64
        function arrayBufferToBase64(buffer) {
            let binary = "";
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
        
        // Remove.bg API function for professional background removal
        async function removeBackground(base64Img, apiKey) {
            if (!base64Img) return null;
            
            try {
                const base64Data = base64Img.replace(/^data:image\/\w+;base64,/, "");
                
                const formData = new FormData();
                formData.append("image_file_b64", base64Data);
                formData.append("size", "auto");
                formData.append("format", "png");
                
                const res = await fetch("https://api.remove.bg/v1.0/removebg", {
                    method: 'POST',
                    headers: {
                        "X-Api-Key": apiKey,
                    },
                    body: formData
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const arrayBuffer = await res.arrayBuffer();
                const base64Result = `data:image/png;base64,${arrayBufferToBase64(arrayBuffer)}`;
                return base64Result;
                
            } catch (err) {
                console.error("remove.bg error:", err.message);
                return base64Img; // fallback to original image
            }
        }

        // Function to convert signature to transparent PNG with better background removal
        function convertSignatureToTransparentPNG(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.getElementById("signatureCanvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = img.width;
                    canvas.height = img.height;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    let transparentPixels = 0;

                    // Adjustable threshold
                    const strongThreshold = 240; // very light (almost white) → fully transparent
                    const softThreshold = 200;  // light gray/off-white → partially transparent

                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const brightness = (r + g + b) / 3;

                        if (brightness > strongThreshold) {
                            // Pure white → fully transparent
                            data[i + 3] = 0;
                            transparentPixels++;
                        } else if (brightness > softThreshold) {
                            // Near-white → soften alpha instead of full removal
                            const fade = (brightness - softThreshold) / (strongThreshold - softThreshold);
                            data[i + 3] = data[i + 3] * (1 - fade);
                        }
                    }

                    console.log(
                        `Signature transparency processed: ${transparentPixels} pure-white pixels removed.`
                    );

                    ctx.putImageData(imageData, 0, 0);

                    // Export PNG with transparency
                    const transparentPNG = canvas.toDataURL("image/png", 1.0);
                    window.transparentSignature = transparentPNG;

                    resolve(transparentPNG);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Form submission handler
        document.getElementById('certificateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submission intercepted by JavaScript');
            initiatePaymentAndGenerateAssignment();
        });



        // Handle exam type selection to show/hide semester number
        document.querySelectorAll('input[name="examType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const semesterGroup = document.getElementById('semesterNumberGroup');
                if (this.value === 'Semester') {
                    semesterGroup.style.display = 'block';
                    document.getElementById('semesterNumber').required = true;
                } else {
                    semesterGroup.style.display = 'none';
                    document.getElementById('semesterNumber').required = false;
                }
            });
        });

        // Handle assignment submission elsewhere selection to show/hide details input
        document.querySelectorAll('input[name="submittedElsewhere"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const detailsArea = document.getElementById('submissionDetailsArea');
                const detailsInput = document.getElementById('submissionDetails');
                
                if (this.value === 'Yes') {
                    detailsArea.style.display = 'block';
                    detailsInput.required = true;
            } else {
                    detailsArea.style.display = 'none';
                    detailsInput.required = false;
                    detailsInput.value = ''; // Clear the input when hiding
                }
            });
        });

        // Course code data for different programs
        const courseCodes = {
            'MBA': [
                { value: 'MMPC-001', text: 'MMPC-001 - Management Functions and Behaviour' },
                { value: 'MMPC-002', text: 'MMPC-002 - Human Resource Management' },
                { value: 'MMPC-003', text: 'MMPC-003 - Economic and Social Environment' },
                { value: 'MMPC-004', text: 'MMPC-004 - Accounting and Finance for Managers' },
                { value: 'MMPC-005', text: 'MMPC-005 - Marketing Management' },
                { value: 'MMPC-006', text: 'MMPC-006 - Information Systems for Managers' },
                { value: 'MMPC-007', text: 'MMPC-007 - Quantitative Analysis for Managerial Applications' },
                { value: 'MMPC-008', text: 'MMPC-008 - Operations Management' },
                { value: 'MMPC-009', text: 'MMPC-009 - Managerial Economics' },
                { value: 'MMPC-010', text: 'MMPC-010 - Organisational Design, Development and Change' }
            ],
            'BBA': [
                { value: 'BBAR-101', text: 'BBAR-101 - Business Communication' },
                { value: 'BBAR-102', text: 'BBAR-102 - Business Mathematics' },
                { value: 'BBAR-103', text: 'BBAR-103 - Principles of Management' },
                { value: 'BBAR-104', text: 'BBAR-104 - Business Environment' },
                { value: 'BBAR-105', text: 'BBAR-105 - Computer Applications in Business' },
                { value: 'BBAR-106', text: 'BBAR-106 - Financial Accounting' }
            ],
            'MCA': [
                { value: 'MCS-011', text: 'MCS-011 - Problem Solving and Programming' },
                { value: 'MCS-012', text: 'MCS-012 - Computer Organisation and Assembly Language Programming' },
                { value: 'MCS-013', text: 'MCS-013 - Discrete Mathematics' },
                { value: 'MCS-014', text: 'MCS-014 - Systems Analysis and Design' },
                { value: 'MCS-015', text: 'MCS-015 - Communication Skills' },
                { value: 'MCS-021', text: 'MCS-021 - Data and File Structures' },
                { value: 'MCS-022', text: 'MCS-022 - Operating System Concepts and Networking Management' },
                { value: 'MCS-023', text: 'MCS-023 - Introduction to Database Management Systems' },
                { value: 'MCS-024', text: 'MCS-024 - Object Oriented Technologies and Java Programming' },
                { value: 'MCS-025', text: 'MCS-025 - Computer Networks' }
            ],
            'BCA': [
                { value: 'BCS-011', text: 'BCS-011 - Computer Basics and PC Software' },
                { value: 'BCS-012', text: 'BCS-012 - Mathematics' },
                { value: 'BCS-013', text: 'BCS-013 - Computer Organization' },
                { value: 'BCS-014', text: 'BCS-014 - C Language Programming' },
                { value: 'BCS-015', text: 'BCS-015 - Communication Skills' },
                { value: 'BCS-021', text: 'BCS-021 - C++ Programming and Data Structures' },
                { value: 'BCS-022', text: 'BCS-022 - Assembly Language Programming' },
                { value: 'BCS-023', text: 'BCS-023 - Database Management Systems' },
                { value: 'BCS-024', text: 'BCS-024 - System Analysis and Design' },
                { value: 'BCS-025', text: 'BCS-025 - Computer Networks' }
            ],
            'B.Tech': [
                { value: 'BT-101', text: 'BT-101 - Mathematics-I' },
                { value: 'BT-102', text: 'BT-102 - Physics' },
                { value: 'BT-103', text: 'BT-103 - Chemistry' },
                { value: 'BT-104', text: 'BT-104 - Engineering Graphics' },
                { value: 'BT-105', text: 'BT-105 - Basic Electrical Engineering' },
                { value: 'BT-106', text: 'BT-106 - Programming in C' },
                { value: 'BT-201', text: 'BT-201 - Mathematics-II' },
                { value: 'BT-202', text: 'BT-202 - Data Structures' },
                { value: 'BT-203', text: 'BT-203 - Digital Electronics' },
                { value: 'BT-204', text: 'BT-204 - Computer Organization' }
            ],
            'M.Tech': [
                { value: 'MT-501', text: 'MT-501 - Advanced Mathematics' },
                { value: 'MT-502', text: 'MT-502 - Advanced Data Structures and Algorithms' },
                { value: 'MT-503', text: 'MT-503 - Computer Networks' },
                { value: 'MT-504', text: 'MT-504 - Database Systems' },
                { value: 'MT-505', text: 'MT-505 - Software Engineering' },
                { value: 'MT-506', text: 'MT-506 - Machine Learning' },
                { value: 'MT-507', text: 'MT-507 - Artificial Intelligence' },
                { value: 'MT-508', text: 'MT-508 - Computer Graphics' },
                { value: 'MT-509', text: 'MT-509 - Distributed Systems' },
                { value: 'MT-510', text: 'MT-510 - Information Security' }
            ]
        };

        // Re-populate course code single-select and dynamic courses multi-select on Program/Exam/Year/Sem changes
        document.getElementById('programSelection').addEventListener('change', function() {
            const courseCodeSelect = document.getElementById('courseCode');
            const selectedProgram = this.value;
            courseCodeSelect.innerHTML = '<option value="">Select a course code</option>';
            if (selectedProgram && courseCodes[selectedProgram]) {
                courseCodes[selectedProgram].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.value;
                    option.textContent = course.text;
                    courseCodeSelect.appendChild(option);
                });
            } else {
                courseCodeSelect.innerHTML = '<option value="">Select a program first</option>';
            }
            updateCoursesSelect();
        });
        document.getElementById('yearSelection').addEventListener('change', updateCoursesSelect);
        document.getElementById('semesterNumber').addEventListener('change', updateCoursesSelect);
        document.querySelectorAll('input[name="examType"]').forEach(r => r.addEventListener('change', updateCoursesSelect));
        
        // Initialize courses checkboxes on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing courses checkboxes');
            console.log('courseCodes object:', courseCodes);
            console.log('Available programs:', Object.keys(courseCodes));
            updateCoursesSelect();
        });

        // Handle signature file selection to convert to transparent PNG
        document.getElementById('signature').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && (file.type.startsWith('image/'))) {
                console.log('Signature file selected:', file.name, file.type, file.size);
                
                // Automatically use remove.bg API for professional background removal
                const apiKey = window.removeBgApiKey;
                console.log('Using remove.bg API for professional background removal');
                
                // Convert file to base64 first
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Img = e.target.result;
                    console.log('Processing with remove.bg API...');
                    
                    removeBackground(base64Img, apiKey).then(transparentPNG => {
                        window.transparentSignature = transparentPNG;
                        console.log('Remove.bg processing completed successfully');
                        console.log('Professional transparent signature size:', transparentPNG.length);
                    }).catch(error => {
                        console.error('Remove.bg processing failed:', error);
                        // Fallback to local processing
                        convertSignatureToTransparentPNG(file).then(transparentPNG => {
                            console.log('Fallback to local processing successful');
                        }).catch(localError => {
                            console.error('Local processing also failed:', localError);
                        });
                    });
                };
                reader.readAsDataURL(file);
            } else {
                console.log('No valid signature file selected');
            }
        });







        // Payment initiation and assignment generation function
        async function initiatePaymentAndGenerateAssignment() {
            try {
                console.log('Starting payment initiation...');
                
                // Check if user is authenticated
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (!isLoggedIn) {
                    showToast('Please log in to continue with payment.', 'warning', 'Login Required');
                    window.location.href = '/login';
                    return;
                }
                
                const formData = new FormData(document.getElementById('certificateForm'));
                
                // Get selected courses from checkboxes
                const selectedCourses = Array.from(document.querySelectorAll('#coursesCheckboxes input[type="checkbox"][name="courses"]:checked')).map(i => i.value);
                if (selectedCourses.length === 0) {
                    showToast('Select at least one course before proceeding.', 'warning');
                    return;
                }
                
                // Get required form data
                const studentName = formData.get('studentName');
                const enrollmentNumber = formData.get('enrollmentNumber');
                const emailId = formData.get('emailId');
                const mobileNumber = formData.get('mobileNumber');
                
                if (!studentName || !enrollmentNumber || !emailId || !mobileNumber) {
                    showToast('Fill all required fields before proceeding.', 'warning');
                    return;
                }
                
                // Calculate amount (₹1 per course)
                const amount = selectedCourses.length;
                
                // Show payment confirmation
                const confirmPayment = await showConfirm(
                    `🎓 Payment Summary\n\n` +
                    `📚 Selected Courses: ${selectedCourses.length}\n` +
                    `   ${selectedCourses.join(', ')}\n\n` +
                    `💰 Amount: ₹${amount}\n` +
                    `👤 Student: ${studentName}\n` +
                    `🆔 Enrollment: ${enrollmentNumber}\n\n` +
                    `🔒 You will be redirected to Cashfree payment gateway.\n` +
                    `Do you want to proceed with the payment?`,
                    {
                        title: '💳 Payment Confirmation',
                        okText: '💳 Pay Now',
                        cancelText: '❌ Cancel'
                    }
                );
                
                if (!confirmPayment) {
                    return;
                }
                
                // Show loading state
                const submitButton = document.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = '⏳ Processing Payment...';
                submitButton.disabled = true;
                
                // Prepare payment data with all form fields
                const paymentData = {
                    courses: selectedCourses,
                    studentName: studentName,
                    enrollmentNumber: enrollmentNumber,
                    emailId: emailId,
                    mobileNumber: mobileNumber,
                    programSelection: formData.get('programSelection'),
                    courseCode: '',
                    studyCenterCode: formData.get('studyCenterCode'),
                    studyCenterAddress: formData.get('studyCenterAddress'),
                    mediumSelection: formData.get('mediumSelection'),
                    examType: formData.get('examType'),
                    semesterNumber: formData.get('semesterNumber'),
                    yearSelection: formData.get('yearSelection'),
                    submittedElsewhere: formData.get('submittedElsewhere'),
                    submissionDetails: formData.get('submissionDetails'),
                    confirmation: formData.get('confirmation'),
                    amount: amount
                };
                
                console.log('Initiating payment with data:', paymentData);
                
                // Call payment initiation endpoint
                const response = await fetch('/initiate-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Payment initiated successfully:', result);
                    
                    // Store payment data for later use
                    window.paymentData = {
                        transactionId: result.transactionId,
                        amount: result.amount,
                        courses: result.courses,
                        paymentUrl: result.paymentUrl,
                        paymentSessionId: result.paymentSessionId
                    };
                    
                    // Store student data in localStorage for payment success
                    const storePaymentData = async () => {
                        const paymentData = {
                            studentName: studentName,
                            enrollmentNumber: enrollmentNumber,
                            emailId: emailId,
                            mobileNumber: mobileNumber,
                            programSelection: formData.get('programSelection'),
                            courseCode: formData.get('courseCode'),
                            studyCenterCode: formData.get('studyCenterCode'),
                            studyCenterAddress: formData.get('studyCenterAddress'),
                            mediumSelection: formData.get('mediumSelection'),
                            examType: formData.get('examType'),
                            semesterNumber: formData.get('semesterNumber'),
                            yearSelection: formData.get('yearSelection'),
                            submittedElsewhere: formData.get('submittedElsewhere'),
                            submissionDetails: formData.get('submissionDetails'),
                            confirmation: formData.get('confirmation'),
                            courses: selectedCourses,
                            amount: amount
                        };

                        // Handle ID card photo
                        const idCardFile = formData.get('idCard');
                        if (idCardFile && idCardFile.size > 0) {
                            try {
                                const idCardDataUrl = await fileToDataURL(idCardFile);
                                paymentData.idCardPhoto = idCardDataUrl;
                            } catch (e) {
                                console.warn("ID card photo conversion failed:", e);
                            }
                        }

                        // Handle signature photo
                        if (window.transparentSignature) {
                            paymentData.signaturePhoto = window.transparentSignature;
                        } else {
                            const signatureFile = formData.get('signature');
                            if (signatureFile && signatureFile.size > 0) {
                                try {
                                    const signatureDataUrl = await fileToDataURL(signatureFile);
                                    paymentData.signaturePhoto = signatureDataUrl;
                                } catch (e) {
                                    console.warn("Signature photo conversion failed:", e);
                                }
                            }
                        }

                        localStorage.setItem('paymentStudentData', JSON.stringify(paymentData));
                    };

                    await storePaymentData();
                    
                    // Initialize Cashfree SDK and redirect to payment
                    try {
                        const cashfree = Cashfree({
                            mode: "production"
                        });
                        
                        let checkoutOptions = {
                            paymentSessionId: result.paymentSessionId,
                            redirectTarget: "_self"
                        };
                        
                        cashfree.checkout(checkoutOptions);
                        
                    } catch (error) {
                        console.error('Cashfree SDK error:', error);
                        // Fallback to direct redirect
                        window.location.href = result.paymentUrl;
                    }
                    
                } else {
                    console.error('Payment initiation failed:', result);
                    
                    // Check if it's an authentication error
                    if (response.status === 401 || response.status === 403) {
                        showToast('Please log in to continue with payment.', 'warning', 'Login Required');
                        window.location.href = '/login';
                        return;
                    }
                    
                    showToast(`Payment initiation failed: ${result.error || 'Unknown error'}`, 'error');
                    
                    // Reset button
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
                
            } catch (error) {
                console.error('Error initiating payment:', error);
                showToast('Error initiating payment. Please try again.', 'error');
                
                // Reset button
                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.textContent = 'Pay & Generate Assignment';
                submitButton.disabled = false;
            }
        }

        // Generate assignment function (now called after payment success)
        async function generateAssignment() {
            const formData = new FormData(document.getElementById('certificateForm'));
            
            // Update certificate fields
            document.getElementById('certStudentName').textContent = formData.get('studentName') || '_________________';
            document.getElementById('certEnrollmentNumber').textContent = formData.get('enrollmentNumber') || '_________________';
            document.getElementById('certProgramSelection').textContent = formData.get('programSelection') || '_________________';
            
            // Handle selected courses from checkboxes
            const selectedCourses = Array.from(document.querySelectorAll('#coursesCheckboxes input[type="checkbox"][name="courses"]:checked')).map(i => i.value);
            if (selectedCourses.length > 0) {
                document.getElementById('certSelectedCourses').textContent = selectedCourses.join(', ');
            } else {
                document.getElementById('certSelectedCourses').textContent = '_________________';
            }
            document.getElementById('certStudyCenterCode').textContent = formData.get('studyCenterCode') || '_________________';
            document.getElementById('certStudyCenterAddress').textContent = formData.get('studyCenterAddress') || '_________________';
            
            // Auto-update Regional Centre based on selected Study Center
            const selectedStudyCenter = formData.get('studyCenterAddress');
            if (selectedStudyCenter) {
                let regionalCentre = 'KOLKATA'; // Default
                if (selectedStudyCenter.includes('Delhi')) {
                    regionalCentre = 'DELHI';
                } else if (selectedStudyCenter.includes('Mumbai')) {
                    regionalCentre = 'MUMBAI';
                } else if (selectedStudyCenter.includes('Chennai')) {
                    regionalCentre = 'CHENNAI';
                } else if (selectedStudyCenter.includes('Bangalore')) {
                    regionalCentre = 'BANGALORE';
                } else if (selectedStudyCenter.includes('Kolkata')) {
                    regionalCentre = 'KOLKATA';
                }
                document.getElementById('certRegionalCentre').textContent = regionalCentre;
            }
            
            document.getElementById('certMobileNumber').textContent = formData.get('mobileNumber') || '_________________';
            document.getElementById('certEmailId').textContent = formData.get('emailId') || '_________________';
            // Handle submission elsewhere with details
            const submittedElsewhere = formData.get('submittedElsewhere');
            const submissionDetails = formData.get('submissionDetails');
            
            if (submittedElsewhere === 'Yes' && submissionDetails) {
                document.getElementById('certSubmittedElsewhere').textContent = `Yes - ${submissionDetails}`;
            } else {
                document.getElementById('certSubmittedElsewhere').textContent = submittedElsewhere || '_________________';
            }
            
            document.getElementById('certConfirmation').textContent = formData.get('confirmation') || '_________________';
            
            // Handle student photo (from ID Card upload)
            const photoFile = document.getElementById('idCard').files[0];
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoImg = document.getElementById('certStudentPhoto');
                    photoImg.src = e.target.result;
                    photoImg.classList.remove('hidden');
                };
                reader.readAsDataURL(photoFile);
            }
            
            // Handle student signature - ensure it's processed before PDF generation
            const signatureFile = document.getElementById('signature').files[0];
            if (signatureFile) {
                try {
                    // Wait for signature conversion to complete
                    await convertSignatureToTransparentPNG(signatureFile);
                    const signatureImg = document.getElementById('certStudentSignature');
                    signatureImg.src = window.transparentSignature;
                    signatureImg.classList.remove('hidden');
                    console.log('Signature processed and ready for PDF generation');
                } catch (error) {
                    console.error('Signature conversion failed:', error);
                    // Fallback to original file if conversion fails
                const reader = new FileReader();
                reader.onload = function(e) {
                    const signatureImg = document.getElementById('certStudentSignature');
                    signatureImg.src = e.target.result;
                    signatureImg.classList.remove('hidden');
                };
                reader.readAsDataURL(signatureFile);
                }
            }
            

            
            // Set month and year in the exam info
            const examType = formData.get('examType');
            let monthText = 'June/Dec';
            let specificMonth = '_______';
            
            console.log('=== EXAM INFO DEBUG ===');
            console.log('Exam type:', examType);
            console.log('Form data examType:', formData.get('examType'));
            console.log('Form data semesterNumber:', formData.get('semesterNumber'));
            console.log('All form data keys:', Array.from(formData.keys()));
            console.log('All form data values:', Array.from(formData.values()));
            
            if (examType === 'Yearly') {
                monthText = 'June/Dec';
                specificMonth = '_______';
                console.log('Yearly exam - monthText set to:', monthText);
            } else if (examType === 'Semester') {
                const semesterNumber = formData.get('semesterNumber');
                console.log('Semester exam - semesterNumber:', semesterNumber);
                if (semesterNumber === '1' || semesterNumber === '3') {
                    monthText = 'June/Dec';
                    specificMonth = 'June';
                    console.log('Semester 1 or 3 - specificMonth set to:', specificMonth);
                } else if (semesterNumber === '2' || semesterNumber === '4') {
                    monthText = 'June/Dec';
                    specificMonth = 'Dec';
                    console.log('Semester 2 or 4 - specificMonth set to:', specificMonth);
                } else {
                    console.log('Invalid semester number:', semesterNumber);
                }
            } else {
                console.log('Invalid exam type:', examType);
            }
            
            const selectedYear = formData.get('yearSelection');
            const yearText = selectedYear || '_______';
            console.log('Selected year:', selectedYear, 'yearText:', yearText);
            console.log('=== END EXAM INFO DEBUG ===');
            
            // Update the exam info text in the certificate
            const examInfoElement = document.querySelector('p.text-sm.text-gray-600.italic.mb-1');
            if (examInfoElement) {
                // Replace the entire text content with the new format
                examInfoElement.innerHTML = `For Term End Exam ${monthText} - <span class="border-b border-gray-400 px-2" style="color: red; font-weight: bold;">${specificMonth}</span> Year - <span class="border-b border-gray-400 px-2" style="color: red; font-weight: bold;">${yearText}</span>`;
                
                console.log('Exam info updated:', monthText, specificMonth, yearText);
            } else {
                console.error('Exam info element not found');
            }
            
            // Set submission date to current date
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const currentDate = `${day}-${month}-${year}`;
            
            // Debug: Check if date element exists and set the date
            const dateElement = document.getElementById('certSubmissionDate');
            if (dateElement) {
                dateElement.textContent = currentDate;
                console.log('Date set to:', currentDate);
            } else {
                console.error('Date element not found');
            }
            
            // Show the download page instead of generating PDFs immediately
            console.log('Showing download page for courses:', selectedCourses);
            
            if (selectedCourses.length === 0) {
                showToast('Select at least one course before generating.', 'warning');
                return;
            }
            
            // Hide the form and show the download page
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('downloadPage').classList.remove('hidden');
            
            // Generate individual course buttons
            generateIndividualCourseButtons(selectedCourses);
            
            // Store selected courses and form data for later use
            window.selectedCourses = selectedCourses;
            window.formData = formData;
        }

        // Generate individual course buttons for the download page
        function generateIndividualCourseButtons(courses) {
            console.log('Generating individual course buttons for:', courses);
            const container = document.getElementById('individualCourseButtons');
            
            if (!container) {
                console.error('Individual subject buttons container not found');
                return;
            }
            
            container.innerHTML = '';
            
            courses.forEach((course, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'subject-btn';
                button.textContent = `📖 ${course}`;
                button.onclick = () => downloadSingleCourse(course);
                container.appendChild(button);
                console.log(`Created button for: ${course}`);
            });
        }

        // Download single course PDF
        async function downloadSingleCourse(courseName) {
            try {
                console.log(`Downloading PDF for course: ${courseName}`);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '⏳ Generating...';
                button.disabled = true;
                
                // Generate and download the PDF for this specific subject
                await downloadPDF(courseName);
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
                console.log(`PDF downloaded successfully for: ${courseName}`);
                
            } catch (error) {
                console.error(`Failed to download PDF for ${courseName}:`, error);
                showToast(`Failed to download PDF for ${courseName}. Please try again.`, 'error');
                
                // Reset button on error
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Download all subjects as ZIP
        async function downloadAllCoursesZip() {
            try {
                console.log('Downloading all subjects as ZIP');
                
                // Show loading state
                const button = document.getElementById('downloadAllZip');
                const originalText = button.textContent;
                button.textContent = '⏳ Creating ZIP...';
                button.disabled = true;
                
                // Use payment data courses if available, otherwise use selected courses
                const courses = window.paymentData?.courses || window.selectedCourses || [];
                
                if (courses.length === 0) {
                    alert('No courses selected. Please go back and select courses.');
                    return;
                }
                
                // Generate PDFs for all courses (skip merge for speed)
                const concurrency = 3;
                const pdfBlobs = [];
                let index = 0;
                async function worker() {
                    while (index < courses.length) {
                        const current = index++;
                        const course = courses[current];
                        const blob = await downloadPDF(course, true, { skipMerge: true });
                        pdfBlobs[current] = blob;
                    }
                }
                const workers = Array.from({ length: Math.min(concurrency, courses.length) }, worker);
                await Promise.all(workers);
                
                // Create ZIP file
                const JSZip = window.JSZip;
                if (!JSZip) {
                    // If JSZip is not available, download PDFs individually
                    alert('ZIP creation not available. Downloading PDFs individually...');
                    subjects.forEach(subject => downloadPDF(subject));
                    return;
                }
                
                const zip = new JSZip();
                
                // Add each PDF to the ZIP
                courses.forEach((course, index) => {
                    if (pdfBlobs[index]) {
                        const fileName = `Assignment_${course}_${new Date().toISOString().split('T')[0]}.pdf`;
                        zip.file(fileName, pdfBlobs[index]);
                    }
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `All_Courses_Assignment_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ZIP file downloaded successfully');
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Failed to create ZIP:', error);
                showToast('Failed to create ZIP. Downloading individually...', 'warning');
                
                // Fallback to individual downloads
                // Use payment data courses if available, otherwise use selected courses
                const courses = window.paymentData?.courses || window.selectedCourses || [];
                courses.forEach(course => downloadPDF(course));
                
                // Reset button
                const button = document.getElementById('downloadAllZip');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Generate individual subject buttons for the download page
        function generateIndividualSubjectButtons(subjects) {
            console.log('Generating individual subject buttons for:', subjects);
            const container = document.getElementById('individualSubjectButtons');
            
            if (!container) {
                console.error('Individual subject buttons container not found');
                return;
            }
            
            container.innerHTML = '';
            
            subjects.forEach((subject, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'subject-btn';
                button.textContent = `📖 ${subject}`;
                button.onclick = () => downloadSingleSubject(subject);
                container.appendChild(button);
                console.log(`Created button for: ${subject}`);
            });
        }

        // Download single subject PDF
        async function downloadSingleSubject(subjectName) {
            try {
                console.log(`Downloading PDF for subject: ${subjectName}`);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '⏳ Generating...';
                button.disabled = true;
                
                // Generate and download the PDF for this specific subject
                await downloadPDF(subjectName);
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
                console.log(`PDF downloaded successfully for: ${subjectName}`);
                
            } catch (error) {
                console.error(`Failed to download PDF for ${subjectName}:`, error);
                showToast(`Failed to download PDF for ${subjectName}. Please try again.`, 'error');
                
                // Reset button on error
                const button = event.target;
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Download all courses as ZIP
        async function downloadAllCoursesZip() {
            try {
                console.log('Downloading all subjects as ZIP');
                
                // Show loading state
                const button = document.getElementById('downloadAllZip');
                const originalText = button.textContent;
                button.textContent = '⏳ Creating ZIP...';
                button.disabled = true;
                
                // Use payment data subjects if available, otherwise use selected subjects
                const subjects = window.paymentData?.subjects || window.selectedSubjects || [];
                
                if (subjects.length === 0) {
                    alert('No subjects selected. Please go back and select subjects.');
                    return;
                }
                
                // Generate PDFs for all subjects
                const pdfPromises = subjects.map(subject => downloadPDF(subject, true)); // true = return blob instead of downloading
                const pdfBlobs = await Promise.all(pdfPromises);
                
                // Create ZIP file
                const JSZip = window.JSZip;
                if (!JSZip) {
                    // If JSZip is not available, download PDFs individually
                    alert('ZIP creation not available. Downloading PDFs individually...');
                    subjects.forEach(subject => downloadPDF(subject));
                    return;
                }
                
                const zip = new JSZip();
                
                // Add each PDF to the ZIP
                subjects.forEach((subject, index) => {
                    if (pdfBlobs[index]) {
                        const fileName = `Assignment_${subject}_${new Date().toISOString().split('T')[0]}.pdf`;
                        zip.file(fileName, pdfBlobs[index]);
                    }
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `All_Subjects_Assignment_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ZIP file downloaded successfully');
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Failed to create ZIP:', error);
                showToast('Failed to create ZIP. Downloading individually...', 'warning');
                
                // Fallback to individual downloads
                // Use payment data courses if available, otherwise use selected courses
                const courses = window.paymentData?.courses || window.selectedCourses || [];
                courses.forEach(course => downloadPDF(course));
                
                // Reset button
                const button = document.getElementById('downloadAllZip');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Generate download buttons for each course
        function generateDownloadButtons(courses) {
            console.log('Generating download buttons for courses:', courses);
            const downloadButtonsContainer = document.getElementById('individualCourseButtons');
            if (!downloadButtonsContainer) {
                console.error('Download buttons container not found');
                return;
            }
            
            downloadButtonsContainer.innerHTML = '';
            
            if (courses.length === 0) {
                // If no courses selected, create one general download button
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-secondary w-full';
                button.textContent = 'Download PDF';
                button.onclick = () => downloadPDF('student_assignment');
                downloadButtonsContainer.appendChild(button);
                console.log('Created general download button');
            } else {
                // Create separate download button for each course
                courses.forEach((course, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-secondary w-full';
                    button.textContent = `Download PDF - ${course}`;
                    button.onclick = () => downloadPDF(course);
                    downloadButtonsContainer.appendChild(button);
                    console.log(`Created download button for: ${course}`);
                });
            }
        }

        // Download PDF function using jsPDF
        async function downloadPDF(subjectName = 'student_assignment', returnBlob = false, opts = {}) {
            try {
                const skipMerge = !!opts.skipMerge;
                // Get form data for the current subject
                const formData = new FormData(document.getElementById('certificateForm'));
                
                // Prepare template data
                // Prefer form inputs; if empty (e.g., after redirect), fallback to stored payment data
                const pd = window.paymentData || (JSON.parse(localStorage.getItem('paymentStudentData') || '{}'));
                const templateData = {
                    name: formData.get('studentName') || pd.studentName || 'Not provided',
                    enrollment: formData.get('enrollmentNumber') || pd.enrollmentNumber || 'Not provided',
                    program: formData.get('programSelection') || pd.programSelection || 'Not provided',
                    courseCode: subjectName || pd.courseCode || 'Not provided',
                    course: subjectName === 'student_assignment' ? 
                        (Array.from(document.querySelectorAll('#coursesCheckboxes input[type="checkbox"][name="courses"]:checked')).map(i => i.value).join(', ') || pd.courses?.join(', ') || pd.subjects?.join(', ') || 'Not provided') : 
                        subjectName,
                    centerCode: formData.get('studyCenterCode') || pd.studyCenterCode || 'Not provided',
                    centerAddress: formData.get('studyCenterAddress') || pd.studyCenterAddress || 'Not provided',
                    center: (formData.get('studyCenterAddress') || pd.studyCenterAddress || 'Delhi').split(' ')[0],
                    mobile: formData.get('mobileNumber') || pd.mobileNumber || 'Not provided',
                    email: formData.get('emailId') || pd.emailId || 'Not provided',
                    assignmentAnyWhereElse: (() => {
                        const submittedElsewhere = formData.get('submittedElsewhere') || pd.submittedElsewhere;
                        const submissionDetails = formData.get('submissionDetails') || pd.submissionDetails;
                        if (submittedElsewhere === 'Yes' && submissionDetails) {
                            return `Yes - ${submissionDetails}`;
                        } else {
                            return submittedElsewhere || 'Not provided';
                        }
                    })(),
                    crossChecked: formData.get('confirmation') || pd.confirmation || 'Not provided',
                    date: new Date().toLocaleDateString('en-GB') || 'Not provided',
                    semester: formData.get('semesterNumber') || pd.semesterNumber || '',
                    year: formData.get('yearSelection') || pd.yearSelection || '',
                    photo: pd.idCardPhoto || null,
                    sign: pd.signaturePhoto || null
                };

                // Handle photo upload
                const photoFile = formData.get('idCard');
                if (photoFile && photoFile.size > 0) {
                    try {
                        const photoDataUrl = await fileToDataURL(photoFile);
                        templateData.photo = photoDataUrl;
                    } catch (e) {
                        console.warn("Photo conversion failed:", e);
                    }
                }

                // Handle signature upload - use transparent signature if available
                if (window.transparentSignature) {
                    console.log('Using transparent signature for PDF');
                    templateData.sign = window.transparentSignature;
                } else {
                    console.log('No transparent signature available, using fallback');
                    // Fallback to original signature processing
                const signatureFile = formData.get('signature');
                if (signatureFile && signatureFile.size > 0) {
                    try {
                        const signatureDataUrl = await fileToDataURL(signatureFile);
                        templateData.sign = signatureDataUrl;
                    } catch (e) {
                        console.warn("Signature conversion failed:", e);
                        }
                    }
                }

                // Generate PDF; when returnBlob is true we need a Blob for ZIPs, otherwise it auto-downloads
                const blob = await prepareAndDownloadPDF(templateData, returnBlob);
                if (returnBlob) {
                    // For ZIP flows, optionally skip merge and just return blob
                    if (skipMerge) return blob;
                    // If not skipping merge, generatePDF already performed merge and returned a blob
                    return blob;
                }
                
            } catch (error) {
                console.error("PDF generation failed:", error);
                if (returnBlob) {
                    return null;
                }
                showToast('PDF generation failed. Please try again.', 'error');
            }
        }

        // Helper function to convert file to data URL
        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                // For image files, use regular FileReader
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                } else {
                    // For non-image files, use regular FileReader
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }
            });
        }

        // Convert image file to Base64
        function getBase64FromImageUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg"));
                };
                img.onerror = (err) => reject(err);
                img.src = url;
            });
        }

        async function prepareAndDownloadPDF(templateData, returnBlob = false) {
            try {
                // Generate PDF directly (logos are handled statically in generatePDF)
                return await generatePDF(templateData, returnBlob);
            } catch (e) {
                console.error("Failed to prepare PDF data:", e);
                if (returnBlob) {
                    return null;
                }
                showToast('PDF preparation failed. Please try again.', 'error');
            }
        }

        // Main PDF generation function using jsPDF
        async function generatePDF(templateData, returnBlob = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt", format: "a4" });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 50;
            const lineHeight = 24;
            const maxWidth = pageWidth - margin * 2;

            // Outer border
            doc.setLineWidth(1);
            doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);

            // IGNOU Logos (left + right) - Always display first
            try {
                // Hindi Logo (image2) - left side - Moved lower
                doc.addImage("https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image2.jpg", "JPEG", margin - 15, margin + 15, 100, 40);
                // English Logo (image4) - right side - Smaller size and moved lower
                doc.addImage("https://raw.githubusercontent.com/payalgit933/ignou-logo/main/image4.jpg", "JPEG", pageWidth - margin - 75, margin + 15, 80, 35);
            } catch (e) {
                console.warn("IGNOU logo loading failed:", e);
                // Fallback text if images fail
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text("IGNOU Logo (Hindi)", margin - 15, margin + 35);
                doc.text("IGNOU Logo (English)", pageWidth - margin - 75, margin + 30);
            }

            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("INDIRA GANDHI NATIONAL OPEN UNIVERSITY", pageWidth / 2, margin + 35, { align: "center" });

            doc.setFontSize(11);
            doc.setTextColor(200, 0, 0);
            doc.text(`Regional Centre ${templateData.center || "Delhi"}`, pageWidth / 2, margin + 55, { align: "center" });
            doc.setTextColor(0, 0, 0);

            // Title
            doc.setFontSize(14);
            doc.text("Format for Assignment Submission", pageWidth / 2, margin + 95, { align: "center" });
            doc.line(pageWidth / 2 - 120, margin + 98, pageWidth / 2 + 120, margin + 98);

            // Exam info and instructions
            doc.setFontSize(11);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100, 100, 100);
            
            // Dynamic exam info based on semester and year
            let examMonth = "June/Dec";
            let specificMonth = "_______";
            if (templateData.semester && templateData.semester !== "") {
                if (["1", "3"].includes(templateData.semester)) {
                    examMonth = "June/Dec";
                    specificMonth = "June";
                } else if (["2", "4"].includes(templateData.semester)) {
                    examMonth = "June/Dec";
                    specificMonth = "Dec";
                }
            }
            
            doc.text(`For Term End Exam ${examMonth} - ${specificMonth} Year - ${templateData.year || "_______"}`, pageWidth / 2, margin + 115, { align: "center" });
            doc.text("(Please read the instructions given below carefully before submitting assignments)", pageWidth / 2, margin + 135, { align: "center" });
            
            // Reset text color and font
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");

            let y = margin + 200;

                        // Row helper
            function addRow(num, label, value) {
                const leftX = margin + 10;
                const labelWidth = 240; // Fixed width for left column
                const valueWidth = maxWidth - 260; // Remaining width for right column
                
                doc.setFont("helvetica", "bold");
                const labelText = `${num}. ${label} : `;
                const wrappedLabel = doc.splitTextToSize(labelText, labelWidth); // wrap label if needed
                doc.text(wrappedLabel, leftX, y);
                
                doc.setFont("helvetica", "normal");
                const wrappedValue = doc.splitTextToSize(value || "__________", valueWidth); // wrap value
                
                // Draw first line of value aligned with the label
                if (wrappedValue.length > 0) {
                    doc.text(wrappedValue[0], leftX + 250, y);
                }
                
                // Draw remaining lines aligned with the label text (not the number)
                for (let i = 1; i < wrappedValue.length; i++) {
                    doc.text(wrappedValue[i], leftX + 250, y + (i * lineHeight));
                }
                
                // Move Y based on tallest block
                const lines = Math.max(wrappedLabel.length, wrappedValue.length);
                y += lineHeight * lines + 6;
                
                // Add small text below row 5 (Course Code)
                if (num === 5) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text("(Use this format course-wise separately)", leftX + 18, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "normal");
                    y += 20; // Add extra space for the small text
                }
                
                // Add additional text below row 9 if "Yes" is selected
                if (num === 9 && value.toLowerCase().includes('yes')) {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text("(Please provide details in the space below)", leftX + 20, y);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "normal");
                    y += 15; // Add extra space for the additional text
                                     }
            }

                         // Rows
             addRow(1, "Name of the Student", templateData.name);
             addRow(2, "Enrollment Number", templateData.enrollment);
             addRow(3, "Programme Code", templateData.program);
             addRow(4, "Course Code", templateData.course);
             addRow(6, "Name of the Study Centre With complete address", templateData.centerAddress);
             addRow(7, "Study Centre Code", templateData.centerCode);
             addRow(8, "Mobile Number", templateData.mobile);
             addRow(9, "Details if this same assignment has been submitted anywhere else also", templateData.assignmentAnyWhereElse);
             addRow(10, "Email ID", templateData.email);
             addRow(11, "Above information cross checked and correct?", templateData.crossChecked);

            // Footer – Date inline
            const footerY = 780;
            const signLabelY = footerY - 40; // Moved up by 40 points
            
            doc.setFont("helvetica", "bold");
            doc.text("Date of Submission:", margin, signLabelY);
            doc.setFont("helvetica", "normal");
            doc.text(templateData.date || "__________", margin + 130, signLabelY);

                         // Footer – Signature (image above text)
             if (templateData.sign) {
                 try {
                     console.log('Adding signature to PDF:', templateData.sign.substring(0, 100) + '...');
                     
                     // For signatures, always use PNG format for transparency
                     let imageFormat = "PNG";
                     
                     // Signature image: 100px × 40px above the text - moved up
                     doc.addImage(templateData.sign, imageFormat, pageWidth - margin - 120, signLabelY - 50, 100, 40);
                     console.log('Signature added to PDF successfully');
                 } catch (e) {
                     console.warn("Signature image failed:", e);
                 }
             } else {
                 console.log('No signature data available for PDF');
             }
            doc.setFont("helvetica", "bold");
            doc.text("Signature of the Student", pageWidth - margin - 120, signLabelY);

            // PAGE 2: Student Photo
            if (templateData.photo) {
                doc.addPage();
                
                // Add the same border as first page
                doc.setLineWidth(1);
                doc.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);
                
                                 try {
                     // Detect image format from data URL
                     let imageFormat = "JPEG";
                     if (templateData.photo.startsWith("data:image/png")) {
                         imageFormat = "PNG";
                     } else if (templateData.photo.startsWith("data:image/webp")) {
                         imageFormat = "WEBP";
                     } else if (templateData.photo.startsWith("data:image/avif")) {
                         imageFormat = "AVIF";
                     }
                     
                     // Set fixed dimensions for the photo
                     const photoWidth = 400;  // Fixed width
                     const photoHeight = 300; // Fixed height
                     
                     // Center the image on the page
                     const x = (pageWidth - photoWidth) / 2;
                     const y = (pageHeight - photoHeight) / 2;
                     
                     doc.addImage(templateData.photo, imageFormat, x, y, photoWidth, photoHeight);
                 } catch (e) {
                     console.warn("Photo addImage failed", e);
                 }
            }

            // Save file with merging - Format: <enrollment_subject>
            const enrollment = templateData.enrollment || "Student";
            const subject = templateData.course || "General";
            const fileName = `${enrollment}_${subject}.pdf`;
            
            // Get the PDF as bytes for merging
            const pdfBytes = doc.output('arraybuffer');
            
            // Merge with subject-specific PDF
            const subjectName = templateData.course || 'General';
            console.log(`Merging PDF for subject: ${subjectName}`);
            console.log('Template data course:', templateData.course);
            console.log('Template data keys:', Object.keys(templateData));
            
            try {
                console.log('Calling mergePDFs function...');
                const mergedPDFBytes = await mergePDFs(pdfBytes, subjectName);
                console.log('Merge completed, merged PDF size:', mergedPDFBytes.byteLength);
                
                // Create download link for merged PDF
                const blob = new Blob([mergedPDFBytes], { type: 'application/pdf' });
                
                if (returnBlob) {
                    // Return blob for ZIP creation
                    return blob;
                }
                
                // Download the PDF
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Merged PDF downloaded successfully');
                
            } catch (error) {
                console.error('PDF merging failed, downloading original:', error);
                console.error('Error details:', error.message);
                
                if (returnBlob) {
                    // Return original PDF blob for ZIP creation
                    const originalBlob = new Blob([doc.output('arraybuffer')], { type: 'application/pdf' });
                    return originalBlob;
                }
                
                // Fallback to original PDF if merging fails
                doc.save(fileName);
            }
        }

        // Test PDF accessibility function
        async function testPDFAccess() {
            console.log('Testing PDF accessibility...');
            const testFiles = ['BCS-53-EM-2025-26.pdf', 'BCS-54-EM-2025-26.pdf'];
            
            for (const file of testFiles) {
                try {
                    const response = await fetch(`pdfs/${file}`);
                    console.log(`${file}: Status ${response.status}, OK: ${response.ok}`);
                    if (response.ok) {
                        const bytes = await response.arrayBuffer();
                        console.log(`${file}: Size ${bytes.byteLength} bytes`);
                    }
                } catch (error) {
                    console.error(`${file}: Error -`, error.message);
                }
            }
        }
        
        // Test PDF access on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, testing PDF accessibility...');
            testPDFAccess();
            // Bind download all button
            const zipBtn = document.getElementById('downloadAllZip');
            if (zipBtn) {
                zipBtn.onclick = downloadAllCoursesZip;
            }
        });

        // Set default date to today
        document.getElementById('yearSelection').value = new Date().getFullYear().toString();
        
        // Check authentication status on page load
        checkAuthStatus();
        
        // Add debugging for authentication
        console.log('Authentication check completed');
        
        // Check if this is a payment success redirect
        const urlParams = new URLSearchParams(window.location.search);
        const paymentSuccess = urlParams.get('payment_success') === 'true';
        const orderId = urlParams.get('order_id');
        
        if (paymentSuccess && orderId) {
            // Show payment success message and download options
            showPaymentSuccess(orderId);
        }
        
        // Server-provided payment data block removed for static HTML. If needed, inject at render time.

        // Helper function to get enrollment number
        function getEnrollmentNumber() {
            return window.formData?.get('enrollmentNumber') || 'Student';
        }
        
        // Function to show payment success and download options
        function showPaymentSuccess(orderId) {
            // Use server payment data if available, otherwise fallback to localStorage data
            let paymentData;
            
            if (window.serverPaymentData) {
                // Use server-provided payment data
                paymentData = {
                    orderId: orderId,
                    amount: window.serverPaymentData.amount || 1,
                    status: window.serverPaymentData.status || 'PAID',
                    courses: window.serverPaymentData.courses || window.serverPaymentData.subjects || [],
                    studentName: window.serverPaymentData.studentName || 'Not Provided',
                    enrollmentNumber: window.serverPaymentData.enrollmentNumber || 'Not Provided',
                    emailId: window.serverPaymentData.emailId || 'Not Provided',
                    mobileNumber: window.serverPaymentData.mobileNumber || 'Not Provided'
                };
            } else {
                // Try to get data from localStorage first
                const storedData = localStorage.getItem('paymentStudentData');
                if (storedData) {
                    try {
                        const parsedData = JSON.parse(storedData);
                        paymentData = {
                            orderId: orderId,
                            amount: parsedData.amount || 1,
                            status: 'PAID',
                            // Support both keys from previous flows
                            subjects: parsedData.subjects || parsedData.courses || [],
                            studentName: parsedData.studentName || 'Not Provided',
                            enrollmentNumber: parsedData.enrollmentNumber || 'Not Provided',
                            emailId: parsedData.emailId || 'Not Provided',
                            mobileNumber: parsedData.mobileNumber || 'Not Provided'
                        };
                    } catch (e) {
                        console.error('Error parsing stored payment data:', e);
                    }
                }
                
                // Fallback to form data if localStorage data is not available
                if (!paymentData) {
                    const selectedCourses = Array.from(document.getElementById('coursesSelect').selectedOptions).map(o => o.value);
                    const coursesToUse = selectedCourses.length > 0 ? selectedCourses : ["MMPC-001"]; 
                    paymentData = {
                        orderId: orderId,
                        amount: 1,
                        status: 'PAID',
                        courses: coursesToUse,
                        studentName: 'Not Provided',
                        enrollmentNumber: 'Not Provided',
                        emailId: 'Not Provided',
                        mobileNumber: 'Not Provided'
                    };
                }
            }
            
            // Normalize courses/subjects into both keys
            const normalizedCourses = (paymentData.courses && paymentData.courses.length ? paymentData.courses : (paymentData.subjects || []));
            paymentData.courses = normalizedCourses;
            paymentData.subjects = normalizedCourses;
            
            // Store payment data for PDF generation
            window.paymentData = paymentData;
            
            // Hide the form and show download page
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('downloadPage').classList.remove('hidden');
            
            // Generate individual course buttons
            generateIndividualCourseButtons(window.paymentData.courses || window.paymentData.subjects || []);
            
            // Show success message
            showToast(`Payment successful! You can now download your assignments for: ${(paymentData.courses || []).join(', ')}`);
        }
        
        // Function to generate individual subject buttons
        function generateIndividualCourseButtons(courses) {
            const container = document.getElementById('individualCourseButtons');
            container.innerHTML = '';
            (courses || []).forEach(subject => {
                const button = document.createElement('button');
                button.className = 'btn btn-primary m-2';
                button.textContent = `📖 ${subject}`;
                button.onclick = () => downloadSingleCourse(subject);
                container.appendChild(button);
            });
        }
        
        // Function to download single subject for payment success
        async function downloadSingleSubjectForPayment(subjectName) {
            try {
                console.log(`Downloading PDF for subject: ${subjectName}`);
                
                // Use server payment data if available, otherwise fallback to form data
                let templateData;
                
                if (window.paymentData && window.paymentData.studentName !== 'Not Provided') {
                    // Use payment data (from server or localStorage)
                    templateData = {
                        name: window.paymentData.studentName || 'Not provided',
                        enrollment: window.paymentData.enrollmentNumber || 'Not provided',
                        program: 'Not provided', // Not available in payment data
                        courseCode: 'Not provided', // Not available in payment data
                        course: subjectName === 'student_assignment' ? 
                            'Not provided' : subjectName,
                        centerAddress: 'Not provided', // Not available in payment data
                        centerCode: 'Not provided', // Not available in payment data
                        mobile: window.paymentData.mobileNumber || 'Not provided',
                        assignmentAnyWhereElse: 'Not provided', // Not available in payment data
                        email: window.paymentData.emailId || 'Not provided',
                        crossChecked: 'Not provided', // Not available in payment data
                        semester: '', // Not available in payment data
                        year: new Date().getFullYear().toString(),
                        center: 'Delhi', // Default
                        date: new Date().toLocaleDateString('en-GB')
                    };
                } else {
                    // Fallback to form data
                    const formData = new FormData(document.getElementById('certificateForm'));
                    
                    templateData = {
                        name: formData.get('studentName') || 'Not provided',
                        enrollment: formData.get('enrollmentNumber') || 'Not provided',
                        program: formData.get('programSelection') || 'Not provided',
                        courseCode: formData.get('courseCode') || 'Not provided',
                        course: subjectName === 'student_assignment' ? 
                            (formData.get('courseCode') || 'Not provided') : subjectName,
                        centerAddress: formData.get('centerAddress') || 'Not provided',
                        centerCode: formData.get('centerCode') || 'Not provided',
                        mobile: formData.get('mobileNumber') || 'Not provided',
                        assignmentAnyWhereElse: formData.get('assignmentAnyWhereElse') || 'Not provided',
                        email: formData.get('email') || 'Not provided',
                        crossChecked: formData.get('crossChecked') || 'Not provided',
                        semester: formData.get('semesterSelection') || '',
                        year: formData.get('yearSelection') || new Date().getFullYear().toString(),
                        center: formData.get('regionalCentre') || 'Delhi',
                        date: new Date().toLocaleDateString('en-GB')
                    };
                    
                    // Handle photo upload from form
                    const photoFile = formData.get('idCard');
                    if (photoFile && photoFile.size > 0) {
                        try {
                            const photoDataUrl = await fileToDataURL(photoFile);
                            templateData.photo = photoDataUrl;
                        } catch (e) {
                            console.warn("Photo conversion failed:", e);
                        }
                    }

                    // Handle signature upload from form
                    if (window.transparentSignature) {
                        console.log('Using transparent signature for PDF');
                        templateData.sign = window.transparentSignature;
                    } else {
                        console.log('No transparent signature available, using fallback');
                        const signatureFile = formData.get('signature');
                        if (signatureFile && signatureFile.size > 0) {
                            try {
                                const signatureDataUrl = await fileToDataURL(signatureFile);
                                templateData.sign = signatureDataUrl;
                            } catch (e) {
                                console.warn("Signature conversion failed:", e);
                            }
                        }
                    }
                }
                
                // Generate PDF with the collected data
                await prepareAndDownloadPDF(templateData, false);
                
                console.log(`PDF downloaded successfully for ${subjectName}`);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showToast('Error downloading PDF. Please try again.', 'error');
            }
        }

        // Function to download all subjects as ZIP for payment success
        async function downloadAllSubjectsZipForPayment() {
            try {
                console.log('Downloading all subjects as ZIP for payment success');
                
                // Show loading state
                const button = document.getElementById('downloadAllZip');
                const originalText = button.textContent;
                button.textContent = '⏳ Creating ZIP...';
                button.disabled = true;
                
                // Use payment data subjects
                const subjects = window.paymentData?.subjects || [];
                
                if (subjects.length === 0) {
                    alert('No subjects available for download.');
                    return;
                }
                
                // Use server payment data if available, otherwise fallback to form data
                let baseTemplateData;
                
                if (window.paymentData && window.paymentData.studentName !== 'Not Provided') {
                    // Use payment data (from server or localStorage)
                    baseTemplateData = {
                        name: window.paymentData.studentName || 'Not provided',
                        enrollment: window.paymentData.enrollmentNumber || 'Not provided',
                        program: window.paymentData.programmeCode || 'Not provided',
                        courseCode: window.paymentData.courseCode || 'Not provided',
                        centerAddress: window.paymentData.studyCenterName || 'Not provided',
                        centerCode: window.paymentData.studyCenterCode || 'Not provided',
                        mobile: window.paymentData.mobileNumber || 'Not provided',
                        assignmentAnyWhereElse: (() => {
                            const submittedElsewhere = window.paymentData.submittedElsewhere;
                            const submissionDetails = window.paymentData.submissionDetails;
                            
                            if (submittedElsewhere === 'Yes' && submissionDetails) {
                                return `Yes - ${submissionDetails}`;
                            } else {
                                return submittedElsewhere || 'Not provided';
                            }
                        })(),
                        email: window.paymentData.emailId || 'Not provided',
                        crossChecked: window.paymentData.confirmation || 'Not provided',
                        semester: window.paymentData.semesterNumber || '',
                        year: window.paymentData.yearSelection || new Date().getFullYear().toString(),
                        center: window.paymentData.studyCenterName ? 
                            window.paymentData.studyCenterName.split(' ')[0] : 'Delhi',
                        date: new Date().toLocaleDateString('en-GB'),
                        photo: window.paymentData.idCardPhoto || null,
                        sign: window.paymentData.signaturePhoto || null
                    };
                } else {
                    // Fallback to form data
                    const formData = new FormData(document.getElementById('certificateForm'));
                    
                    baseTemplateData = {
                        name: formData.get('studentName') || 'Not provided',
                        enrollment: formData.get('enrollmentNumber') || 'Not provided',
                        program: formData.get('programSelection') || 'Not provided',
                        courseCode: formData.get('courseCode') || 'Not provided',
                        centerAddress: formData.get('studyCenterAddress') || 'Not provided',
                        centerCode: formData.get('studyCenterCode') || 'Not provided',
                        mobile: formData.get('mobileNumber') || 'Not provided',
                        assignmentAnyWhereElse: (() => {
                            const submittedElsewhere = formData.get('submittedElsewhere');
                            const submissionDetails = formData.get('submissionDetails');
                            
                            if (submittedElsewhere === 'Yes' && submissionDetails) {
                                return `Yes - ${submissionDetails}`;
                            } else {
                                return submittedElsewhere || 'Not provided';
                            }
                        })(),
                        email: formData.get('emailId') || 'Not provided',
                        crossChecked: formData.get('confirmation') || 'Not provided',
                        semester: formData.get('semesterNumber') || '',
                        year: formData.get('yearSelection') || new Date().getFullYear().toString(),
                        center: formData.get('studyCenterAddress') ? 
                            formData.get('studyCenterAddress').split(' ')[0] : 'Delhi',
                        date: new Date().toLocaleDateString('en-GB'),
                        photo: null,
                        sign: null
                    };
                    
                    // Handle photo upload from form
                    const photoFile = formData.get('idCard');
                    if (photoFile && photoFile.size > 0) {
                        try {
                            const photoDataUrl = await fileToDataURL(photoFile);
                            baseTemplateData.photo = photoDataUrl;
                        } catch (e) {
                            console.warn("Photo conversion failed:", e);
                        }
                    }

                    // Handle signature upload from form
                    if (window.transparentSignature) {
                        console.log('Using transparent signature for PDF');
                        baseTemplateData.sign = window.transparentSignature;
                    } else {
                        console.log('No transparent signature available, using fallback');
                        const signatureFile = formData.get('signature');
                        if (signatureFile && signatureFile.size > 0) {
                            try {
                                const signatureDataUrl = await fileToDataURL(signatureFile);
                                baseTemplateData.sign = signatureDataUrl;
                            } catch (e) {
                                console.warn("Signature conversion failed:", e);
                            }
                        }
                    }
                }
                
                // Generate PDFs for all subjects
                const pdfPromises = subjects.map(subject => {
                    const templateData = {
                        ...baseTemplateData,
                        course: subject === 'student_assignment' ? 
                            (formData.get('courseCode') || 'Not provided') : subject
                    };
                    return prepareAndDownloadPDF(templateData, true); // true = return blob
                });
                const pdfBlobs = await Promise.all(pdfPromises);
                
                // Create ZIP file
                const JSZip = window.JSZip;
                if (!JSZip) {
                    // If JSZip is not available, download PDFs individually
                    alert('ZIP creation not available. Downloading PDFs individually...');
                    subjects.forEach(subject => downloadSingleSubjectForPayment(subject));
                    return;
                }
                
                const zip = new JSZip();
                
                // Add each PDF to the ZIP
                subjects.forEach((subject, index) => {
                    if (pdfBlobs[index]) {
                        const fileName = `Assignment_${subject}_${new Date().toISOString().split('T')[0]}.pdf`;
                        zip.file(fileName, pdfBlobs[index]);
                    }
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `IGNOU_Assignments_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('ZIP file downloaded successfully');
                
            } catch (error) {
                console.error('Error creating ZIP file:', error);
                showToast('Error creating ZIP file. Please try again.', 'error');
            } finally {
                // Restore button state
                const button = document.getElementById('downloadAllZip');
                button.textContent = '📥 Download All Subjects (ZIP)';
                button.disabled = false;
            }
        }

        // Add event listeners for download page buttons
        document.getElementById('downloadAllZip').addEventListener('click', function() {
            // Check if this is payment success flow
            if (window.paymentData) {
                downloadAllSubjectsZipForPayment();
            } else {
                downloadAllSubjectsZip();
            }
        });
        document.getElementById('backToForm').addEventListener('click', function() {
            // Hide download page and show form
            document.getElementById('downloadPage').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        });
        
        // Authentication functions
        function checkAuthStatus() {
            const userData = localStorage.getItem('userData');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (userData && isLoggedIn === 'true') {
                try {
                    const user = JSON.parse(userData);
                    showUserStatus(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    clearUserData();
                }
            } else {
                showAuthLinks();
            }
        }

        function showUserStatus(user) {
            // Add user status display to the page if needed
            console.log('User logged in:', user);
        }

        function showAuthLinks() {
            // Redirect to welcome page if not authenticated
            window.location.href = '/welcome';
        }

        function clearUserData() {
            localStorage.removeItem('userData');
            localStorage.removeItem('isLoggedIn');
            showAuthLinks();
        }

        // Function to update PDF elements with payment data
        function updatePDFElementsWithPaymentData() {
            if (!window.paymentData) return;
            
            // Update text fields in PDF template
            const elements = {
                'certStudentName': window.paymentData.studentName,
                'certEnrollmentNumber': window.paymentData.enrollmentNumber,
                'certProgramSelection': window.paymentData.programmeCode,
                'certCourseCode': window.paymentData.courseCode,
                'certStudyCenterCode': window.paymentData.studyCenterCode,
                'certStudyCenterAddress': window.paymentData.studyCenterName,
                'certEmailId': window.paymentData.emailId,
                'certMobileNumber': window.paymentData.mobileNumber,
                'certMediumSelection': window.paymentData.mediumSelection,
                'certExamType': window.paymentData.examType,
                'certSemesterNumber': window.paymentData.semesterNumber,
                'certYearSelection': window.paymentData.yearSelection,
                'certSubmittedElsewhere': window.paymentData.submittedElsewhere,
                'certSubmissionDetails': window.paymentData.submissionDetails,
                'certConfirmation': window.paymentData.confirmation
            };
            
            // Update text elements
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element && value && value !== 'Not Provided') {
                    element.textContent = value;
                }
            });
            
            // Update images
            if (window.paymentData.idCardPhoto) {
                const photoElement = document.getElementById('certStudentPhoto');
                if (photoElement) {
                    photoElement.src = window.paymentData.idCardPhoto;
                    photoElement.style.display = 'block';
                }
            }
            
            if (window.paymentData.signaturePhoto) {
                const signatureElement = document.getElementById('certStudentSignature');
                if (signatureElement) {
                    signatureElement.src = window.paymentData.signaturePhoto;
                    signatureElement.style.display = 'block';
                }
            }
            
            // Update subjects
            if (window.paymentData.subjects && window.paymentData.subjects.length > 0) {
                const subjectsElement = document.getElementById('certSelectedSubjects');
                if (subjectsElement) {
                    subjectsElement.textContent = window.paymentData.subjects.join(', ');
                }
            }
            
            console.log('PDF elements updated with payment data');
        }

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Check if this is a payment success page
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success') === 'true';
            
            if (paymentSuccess) {
                // Load payment data from localStorage
                const paymentStudentData = localStorage.getItem('paymentStudentData');
                if (paymentStudentData) {
                    try {
                        const data = JSON.parse(paymentStudentData);
                        window.paymentData = {
                            ...window.paymentData,
                            ...data
                        };
                        console.log('Payment data loaded from localStorage:', window.paymentData);
                        
                        // Handle images if they exist
                        if (data.idCardPhoto) {
                            window.paymentData.idCardPhoto = data.idCardPhoto;
                        }
                        if (data.signaturePhoto) {
                            window.paymentData.signaturePhoto = data.signaturePhoto;
                        }
                        
                        // Update PDF elements with payment data
                        updatePDFElementsWithPaymentData();
                        
                    } catch (e) {
                        console.error('Error parsing payment data:', e);
                    }
                }
                
                // Show download page
                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('downloadPage').classList.remove('hidden');
                
                // Generate download buttons
                const subjects = window.paymentData?.subjects || [];
                generateDownloadButtons(subjects);
            } else {
                // Normal form page
                checkAuthStatus();
            }
        });

        // Toast + Confirm helpers
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `${title ? `<div class=\"title\">${title}</div>` : ''}<div class=\"msg\">${message}</div>`;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; }, 2400);
            setTimeout(() => { el.remove(); }, 3000);
        }

        function showConfirm(message, options = {}) {
            return new Promise(resolve => {
                const overlay = document.getElementById('confirmOverlay');
                const header = document.getElementById('confirmHeader');
                const body = document.getElementById('confirmBody');
                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');
                
                if (!overlay || !body || !okBtn || !cancelBtn) return resolve(false);
                
                // Update header if provided
                if (options.title) {
                    header.textContent = options.title;
                } else {
                    header.textContent = 'Please Confirm';
                }
                
                // Update body with message
                body.textContent = message;
                
                // Update button texts if provided
                if (options.okText) {
                    okBtn.textContent = options.okText;
                } else {
                    okBtn.textContent = 'OK';
                }
                
                if (options.cancelText) {
                    cancelBtn.textContent = options.cancelText;
                } else {
                    cancelBtn.textContent = 'Cancel';
                }
                
                // Show modal with animation
                overlay.style.display = 'flex';
                
                // Add click outside to close
                const handleOverlayClick = (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve(false);
                    }
                };
                
                // Add escape key to close
                const handleEscapeKey = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(false);
                    }
                };
                
                const cleanup = () => { 
                    overlay.style.display = 'none'; 
                    okBtn.onclick = null; 
                    cancelBtn.onclick = null;
                    overlay.removeEventListener('click', handleOverlayClick);
                    document.removeEventListener('keydown', handleEscapeKey);
                };
                
                okBtn.onclick = () => { cleanup(); resolve(true); };
                cancelBtn.onclick = () => { cleanup(); resolve(false); };
                overlay.addEventListener('click', handleOverlayClick);
                document.addEventListener('keydown', handleEscapeKey);
            });
        }
    </script>
</body>
</html>






